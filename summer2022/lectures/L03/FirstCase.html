
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flow on the pore scale &mdash; HydrothermalFoam Lecture  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Exercises" href="Exercise.html" />
    <link rel="prev" title="Digital Rock Physics - Effective Permeability of Rocks" href="intro.html" /> 
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EJ32EEFYRN"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EJ32EEFYRN');
    </script>   

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> HydrothermalFoam Lecture
            <img src="../../_static/htf_picto2.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Course information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general-info/course-details.html">Course details</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L01/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L01/Installation.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L01/OpenFoam.html">Getting started with OpenFoam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L01/FirstCase.html">A first test case - heat diffusion</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L02/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L02/Example.html">Navier-Stokes flow with OpenFoam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L02/Exercise.html">Excercise</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 3</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Digital Rock Physics - Effective Permeability of Rocks</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Flow on the pore scale</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#objective">Objective</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mesh-generation">Mesh generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#python-pre-processing">Python pre-processing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#openfoam-case">OpenFOAM case</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#making-the-mesh">Making the mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="#boundary-conditions">Boundary conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transport-properties">Transport properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="#case-control">Case control</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-case">Running the case</a></li>
<li class="toctree-l3"><a class="reference internal" href="#post-processing-effective-permeability">Post-processing / Effective permeability</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Exercise.html">Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="Theory.html">Theoretical background</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 4</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L04/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L04/intro.html">Porous Flow - Submarine Hydrothermal Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L04/FirstCase.html">Hydrothermal convection test case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L04/Exercise.html">Excercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 5</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L05/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/intro.html">Upflow temperatures in submarine hydrothermal systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/Exercise1.html">Exercise 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/Exercise2.html">Exercise 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/Exercise3.html">Exercise 3</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 6</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L06/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L06/intro.html">Structural controls on hydrothermal flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L06/Exercise1.html">Exercise 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L06/Exercise2.html">Exercise 2</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 7</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L_FVM/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L_FVM/intro.html">FVM and OpenFoam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L_FVM/Exercise1.html">Exercise 1</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L_PROJECTS/Project1.html">Project 1: Flow along a detachment fault</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L_PROJECTS/Project2.html">Project 2: How long can a magmatic intrusion sustain high temperature venting?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L_PROJECTS/Project3.html">Project 3: Hydrofracturing and localized venting above sill intrusion?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../refs.html">References</a></li>
</ul>


    
        <p class="caption">
            <span class="caption-text">Getting help</span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="mailto:lruepke@geomar.de"><i class="fa fa-envelope fa-fw"></i> Prof. Lars Ruepke</a></li>
            
                <li class="toctree-l1"><a href="mailto:zguo@geomar.de"><i class="fa fa-envelope fa-fw"></i> Dr. Zhikui Guo</a></li>
            
                <li class="toctree-l1"><a href="https://www.hydrothermalfoam.info"><i class="fa fa-gitlab fa-fw"></i> HydrothermalFoam</a></li>
            
                <li class="toctree-l1"><a href="https://www.openfoam.org"><i class="fa fa-github fa-fw"></i> OpenFOAM</a></li>
            
                <li class="toctree-l1"><a href="https://lruepke.github.io/HTF_lecture/"><i class="fa fa-home fa-fw"></i> Public site</a></li>
            
                <li class="toctree-l1"><a href="https://lms.uni-kiel.de/url/RepositoryEntry/3664576582"><i class="fa fa-home fa-fw"></i> University site</a></li>
            
        </ul>
    

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">HydrothermalFoam Lecture</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Flow on the pore scale</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/lruepke/HTF_lecture/blob/main/Summer2022/source/lectures/L03/FirstCase.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="flow-on-the-pore-scale">
<span id="l03-firstcase"></span><h1>Flow on the pore scale<a class="headerlink" href="#flow-on-the-pore-scale" title="Permalink to this headline"></a></h1>
<section id="objective">
<h2>Objective<a class="headerlink" href="#objective" title="Permalink to this headline"></a></h2>
<p>Starting from a digital representation of a sample’s pore space (typically an image produced by a cT-scan), we want to compute the permeability of the sample. Put differently, we will make a <strong>direct</strong> simulation of flow on the pore level and post-process it for extracting the permeability to be used, for example, in simplified <strong>continuum</strong> simulations using Darcy’s law.</p>
<figure class="align-center" id="fig-porousmodel-fig" style="width: 70%">
<img alt="../../_images/porousModel.png" src="../../_images/porousModel.png" />
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text">Synthetic image of the pore geometry. Pores are white; solids are black.</span><a class="headerlink" href="#fig-porousmodel-fig" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>To compute permeability, we will apply constant pressure boundary conditions and evaluate the flow rate through the sample. Once we have that, we can re-arrange Darcy’s law to solve for permeability:</p>
<div class="math notranslate nohighlight" id="equation-eq-darcy-perm">
<span class="eqno">(7)<a class="headerlink" href="#equation-eq-darcy-perm" title="Permalink to this equation"></a></span>\[    K_{i,j} \, = \, \mu \Biggl( \frac{ \Delta P}{ \Delta x_j} \Biggr)^{-1} \, \Biggl( \frac{1}{V} \int_V u_i \, dV \Biggr) \; .\]</div>
<p>Ok, let’s do it!</p>
</section>
<section id="mesh-generation">
<h2>Mesh generation<a class="headerlink" href="#mesh-generation" title="Permalink to this headline"></a></h2>
<p>The first major step is to generate a mesh of the pore space (<a class="reference internal" href="#fig-porousmodel-fig"><span class="std std-numref">Fig. 11</span></a>). For this purpose, we will use <a class="reference external" href="https://cfd.direct/openfoam/user-guide/v7-snappyHexMesh/#x27-1970005.4">OpenFOAM’s snappyHexMesh tool</a>. It allows meshing arbitrary and complex geometries and is very powerful. Unfortunately, it can also be infuriating to use as it asks for many user-defined parameters and can be quite picky about the choices made.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We will not go into the details of snappyHexMesh (SHM) works. If you want to use and/or understand it, a good starting point is the user guide linked above. Another great resource is the <a class="reference external" href="https://holzmann-cfd.com/community/training-videos/openfoam-usage/rock-vapor-classic">Rock Vapor Classic tutorial series</a>.</p>
</div>
<p>In a nutshell, snappyHexMesh (SHM) is about starting from a blockMesh (as in the previous lecture), cutting out the solid grain (described by a triangulated surface), and then <em>snapping</em> the mesh to this surface. A typical way to describe this surface is an .stl file - a file format for triangulated surfaces that is often used for 3D printing.</p>
<figure class="align-center" id="fig-figure-workflow-fig" style="width: 85%">
<img alt="../../_images/figure_workflow.jpg" src="../../_images/figure_workflow.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 12 </span><span class="caption-text">Workflow illustrating the meshing process.</span><a class="headerlink" href="#fig-figure-workflow-fig" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The steps involved are shown in <a class="reference internal" href="#fig-figure-workflow-fig"><span class="std std-numref">Fig. 12</span></a> . Starting from an image, an stl file is created that is then used during the meshing process. Most of the steps will rely on paraview filters and the workflow is this.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Start with an image (A).</p></li>
<li><p>Save it as a .vti file that is easily understood by Paraview. We use <a class="reference external" href="https://porespy.org/">porespy</a> for this step.</p></li>
<li><p>Load the vti file into paraview and use the <em>clip</em> (B) and <em>triangulation</em> (B) filers to created a surface of the pore space (C).</p></li>
<li><p>Save this surface as a stl file</p></li>
</ol>
</div></blockquote>
<section id="python-pre-processing">
<h3>Python pre-processing<a class="headerlink" href="#python-pre-processing" title="Permalink to this headline"></a></h3>
<p>Let’s work through the steps involved and assume we received a 2-D image of scanned pore space ( <a class="reference internal" href="#fig-figure-workflow-fig"><span class="std std-numref">Fig. 12</span></a> A). We need to translate it into something that Paraview understands, so that we can do the segmentation and surface generation. We will use porespy for it and the first step is to install porespy into our python virtual environment (we should already have PIL, which is also needed).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda activate <span class="s2">&quot;your_environment_name&quot;</span>
conda install -c conda-forge porespy
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If conda install fails, you can also use <code class="code docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">porespy</span></code></p>
</div>
<p>Now we are good to go and it’s time to download the data. The complete openFOAM case can be downloaded from <a class="reference download internal" download="" href="../../_downloads/65ca8e602751cf5a43c9c804c6623d86/DRP_permeability_2D.zip"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a> .</p>
<p>Copy the case into your shared working directory (probably $HOME/HydrothermalFoam_runs). You need to do this within the docker container (your right-hand shell in Visual Studio Code if you followed the recommended setup).</p>
<p>Check out the directory structure shown in <a class="reference internal" href="#lst-drp-case-tree"><span class="std std-numref">Listing 11</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="lst-drp-case-tree">
<div class="code-block-caption"><span class="caption-number">Listing 11 </span><span class="caption-text">File tree structure of the Digital Rock Physics case.</span><a class="headerlink" href="#lst-drp-case-tree" title="Permalink to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
├── <span class="m">0</span>
│   ├── U
│   └── p
├── a.foam
├── clean.sh
├── constant
│   ├── transportProperties
│   ├── triSurface
│   └── turbulenceProperties
├── geometry
│   └── porousModel.png
├── run.sh
└── system
    ├── blockMeshDict
    ├── controlDict
    ├── fvSchemes
    ├── fvSolution
    ├── meshQualityDict
    └── snappyHexMeshDict
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Most OpenFoam cases include scripts like <code class="code docutils literal notranslate"><span class="pre">run.sh</span></code> and <code class="code docutils literal notranslate"><span class="pre">clean.sh</span></code>. The <code class="code docutils literal notranslate"><span class="pre">run.sh</span></code> script is a good starting point for “understanding” a case. It lists all commands that have to be executed (e.g. meshing, setting of properties, etc.) to run a case. The <code class="code docutils literal notranslate"><span class="pre">clean.sh</span></code> script cleans up the case and deletes e.g. the mesh and all output directories. Have a look into these files and see if you understand them!</p>
</div>
<p>Next we import the .png file from the <code class="code docutils literal notranslate"><span class="pre">geometry</span></code> folder and convert it to a .vti file, which is the <a class="reference external" href="https://vtk.org">Visualization Toolkit’s</a> format for storing image data. Note that vti files can also store series of images, which is important when doing this in 3-D.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">porespy</span> <span class="k">as</span> <span class="nn">ps</span>

<span class="n">impath</span> <span class="o">=</span> <span class="s1">&#39;geometry/&#39;</span>         <span class="c1"># image path</span>
<span class="n">imname</span> <span class="o">=</span> <span class="s1">&#39;porousModel.png&#39;</span>   <span class="c1"># file name</span>

<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">impath</span><span class="p">,</span><span class="n">imname</span><span class="p">))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>                   <span class="c1"># open image</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>                                                    <span class="c1"># convert image to array</span>
<span class="n">ps</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">to_vtk</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="s1">&#39;porous_model&#39;</span><span class="p">)</span>   <span class="c1"># use porespy and save to .vti format</span>
</pre></div>
</div>
<p>You can put this little script into a jupyter notebook, or save it as .py file to be run from the command line. After running it, you should  have a file <code class="code docutils literal notranslate"><span class="pre">porous_model.vti</span></code> in the folder where you executed the script. Now comes the segementation and triangulation part. We can use paraview’s python interface for this (or do everything by hand using the graphical user interface).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;your_case_directory&quot;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;your_file_name.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># workflow as python code using the paraview.simple module</span>
<span class="kn">from</span> <span class="nn">paraview.simple</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">write_stl</span><span class="p">(</span><span class="n">vti_file</span><span class="p">,</span> <span class="n">stl_file</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">OpenDataFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.vti&#39;</span><span class="o">%</span><span class="n">vti_file</span><span class="p">)</span>
    <span class="n">clip1</span> <span class="o">=</span> <span class="n">Clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ClipType</span> <span class="o">=</span> <span class="s1">&#39;Scalar&#39;</span><span class="p">,</span> <span class="n">Scalars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CELLS&#39;</span><span class="p">,</span> <span class="s1">&#39;im&#39;</span><span class="p">],</span> <span class="n">Value</span> <span class="o">=</span> <span class="mf">127.5</span><span class="p">,</span> <span class="n">Invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">extractSurface1</span> <span class="o">=</span> <span class="n">ExtractSurface</span><span class="p">(</span><span class="n">clip1</span><span class="p">)</span>
    <span class="n">triangulate1</span> <span class="o">=</span> <span class="n">Triangulate</span><span class="p">(</span><span class="n">extractSurface1</span><span class="p">)</span>
    <span class="n">SaveData</span><span class="p">(</span><span class="n">stl_file</span><span class="p">,</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">triangulate1</span><span class="p">)</span>

<span class="n">vti_file</span> <span class="o">=</span> <span class="s1">&#39;porous_model&#39;</span>      <span class="c1"># input .vti file</span>
<span class="n">stl_file</span> <span class="o">=</span> <span class="s1">&#39;porous_model.stl&#39;</span>  <span class="c1"># output .stl file</span>

<span class="n">write_stl</span><span class="p">(</span><span class="n">vti_file</span><span class="p">,</span> <span class="n">stl_file</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" id="fig-paraview-figure-fig" style="width: 85%">
<img alt="../../_images/paraview_python.png" src="../../_images/paraview_python.png" />
<figcaption>
<p><span class="caption-number">Fig. 13 </span><span class="caption-text">Using the paraview python shell.</span><a class="headerlink" href="#fig-paraview-figure-fig" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>This will create a .stl file, which we will use in the meshing process. Let’s do some clean up and move the vti file into <code class="code docutils literal notranslate"><span class="pre">./geometry</span></code> and the stl file into <code class="code docutils literal notranslate"><span class="pre">./constant/triSurface</span></code>, where openFOAM expects it. This assumes that you are in the case directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mv ./porous_model.vti ./geometry/
mv ./porous_model.stl ./constant/triSurface/
</pre></div>
</div>
</section>
</section>
<section id="openfoam-case">
<h2>OpenFOAM case<a class="headerlink" href="#openfoam-case" title="Permalink to this headline"></a></h2>
<section id="making-the-mesh">
<h3>Making the mesh<a class="headerlink" href="#making-the-mesh" title="Permalink to this headline"></a></h3>
<p>Great, back to openfoam for the final mesh making! Making the mesh with SHM is a two-step process. First we make a standard blockMesh background mesh. This is, as usual, controlled by <code class="code docutils literal notranslate"><span class="pre">system/blockMeshDict</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-number">Listing 12 </span><span class="caption-text">blockMeshDict</span><a class="headerlink" href="#id1" title="Permalink to this code"></a></div>
<div class="highlight-foam notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*--------------------------------*- C++ -*----------------------------------*\</span>
<span class="linenos"> 2</span><span class="cm">=========                 |</span>
<span class="linenos"> 3</span><span class="cm">\\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox</span>
<span class="linenos"> 4</span><span class="cm"> \\    /   O peration     | Website:  https://openfoam.org</span>
<span class="linenos"> 5</span><span class="cm">  \\  /    A nd           | Version:  7</span>
<span class="linenos"> 6</span><span class="cm">   \\/     M anipulation  |</span>
<span class="linenos"> 7</span><span class="cm">\*---------------------------------------------------------------------------*/</span>
<span class="linenos"> 8</span><span class="k">FoamFile</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span>    <span class="kt">version</span>     <span class="mf">2.0</span><span class="p">;</span>
<span class="linenos">11</span>    <span class="kt">format</span>      <span class="k">ascii</span><span class="p">;</span>
<span class="linenos">12</span>    <span class="kt">class</span>       <span class="k">dictionary</span><span class="p">;</span>
<span class="linenos">13</span>    <span class="kt">object</span>      <span class="n">blockMeshDict</span><span class="p">;</span>
<span class="linenos">14</span><span class="p">}</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="c1">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="k">convertToMeters</span> <span class="mi">1</span><span class="p">;</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="n">lx0</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">21</span><span class="n">ly0</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">22</span><span class="n">lz0</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">23</span>
<span class="hll"><span class="linenos">24</span><span class="n">lx1</span> <span class="mi">1196</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">25</span><span class="n">ly1</span> <span class="mi">1494</span><span class="p">;</span>
</span><span class="linenos">26</span><span class="n">lz1</span> <span class="mi">1</span><span class="p">;</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="k">vertices</span>
<span class="linenos">29</span><span class="p">(</span>
<span class="linenos">30</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx0</span> <span class="k">$</span><span class="n">ly0</span> <span class="k">$</span><span class="n">lz0</span><span class="p">)</span>   <span class="c1">//0</span>
<span class="linenos">31</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx1</span> <span class="k">$</span><span class="n">ly0</span> <span class="k">$</span><span class="n">lz0</span><span class="p">)</span>   <span class="c1">//1</span>
<span class="linenos">32</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx1</span> <span class="k">$</span><span class="n">ly1</span> <span class="k">$</span><span class="n">lz0</span><span class="p">)</span>   <span class="c1">//2</span>
<span class="linenos">33</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx0</span> <span class="k">$</span><span class="n">ly1</span> <span class="k">$</span><span class="n">lz0</span><span class="p">)</span>   <span class="c1">//3</span>
<span class="linenos">34</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx0</span> <span class="k">$</span><span class="n">ly0</span> <span class="k">$</span><span class="n">lz1</span><span class="p">)</span>   <span class="c1">//4</span>
<span class="linenos">35</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx1</span> <span class="k">$</span><span class="n">ly0</span> <span class="k">$</span><span class="n">lz1</span><span class="p">)</span>   <span class="c1">//5</span>
<span class="linenos">36</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx1</span> <span class="k">$</span><span class="n">ly1</span> <span class="k">$</span><span class="n">lz1</span><span class="p">)</span>   <span class="c1">//6</span>
<span class="linenos">37</span>    <span class="p">(</span><span class="k">$</span><span class="n">lx0</span> <span class="k">$</span><span class="n">ly1</span> <span class="k">$</span><span class="n">lz1</span><span class="p">)</span>   <span class="c1">//7</span>
<span class="linenos">38</span><span class="p">);</span>
<span class="linenos">39</span>
<span class="hll"><span class="linenos">40</span><span class="k">blocks</span>
</span><span class="linenos">41</span><span class="p">(</span>
<span class="linenos">42</span>    <span class="k">hex</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="mi">315</span> <span class="mi">390</span> <span class="mi">1</span><span class="p">)</span> <span class="k">simpleGrading</span> <span class="p">(</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">43</span><span class="p">);</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="k">edges</span>
<span class="linenos">46</span><span class="p">(</span>
<span class="linenos">47</span><span class="p">);</span>
<span class="linenos">48</span>
<span class="hll"><span class="linenos">49</span><span class="k">boundary</span>
</span><span class="linenos">50</span><span class="p">(</span>
<span class="linenos">51</span>    <span class="n">top</span>
<span class="linenos">52</span>    <span class="p">{</span>
<span class="linenos">53</span>        <span class="kt">type</span> <span class="n">symmetryPlane</span><span class="p">;</span>
<span class="linenos">54</span>        <span class="k">faces</span>
<span class="linenos">55</span>        <span class="p">(</span>
<span class="linenos">56</span>            <span class="p">(</span><span class="mi">7</span> <span class="mi">6</span> <span class="mi">3</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">57</span>        <span class="p">);</span>
<span class="linenos">58</span>    <span class="p">}</span>
<span class="linenos">59</span>
<span class="linenos">60</span>    <span class="n">inlet</span>
<span class="linenos">61</span>    <span class="p">{</span>
<span class="linenos">62</span>        <span class="kt">type</span> <span class="n">wall</span><span class="p">;</span>
<span class="linenos">63</span>        <span class="k">faces</span>
<span class="linenos">64</span>        <span class="p">(</span>
<span class="linenos">65</span>            <span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span> <span class="mi">3</span><span class="p">)</span>
<span class="linenos">66</span>        <span class="p">);</span>
<span class="linenos">67</span>    <span class="p">}</span>
<span class="linenos">68</span>
<span class="linenos">69</span>    <span class="n">bottom</span>
<span class="linenos">70</span>    <span class="p">{</span>
<span class="linenos">71</span>        <span class="kt">type</span> <span class="n">symmetryPlane</span><span class="p">;</span>
<span class="linenos">72</span>        <span class="k">faces</span>
<span class="linenos">73</span>        <span class="p">(</span>
<span class="linenos">74</span>            <span class="p">(</span><span class="mi">1</span> <span class="mi">5</span> <span class="mi">4</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">75</span>        <span class="p">);</span>
<span class="linenos">76</span>    <span class="p">}</span>
<span class="linenos">77</span>
<span class="linenos">78</span>    <span class="n">outlet</span>
<span class="linenos">79</span>    <span class="p">{</span>
<span class="linenos">80</span>        <span class="kt">type</span> <span class="n">patch</span><span class="p">;</span>
<span class="linenos">81</span>        <span class="k">faces</span>
<span class="linenos">82</span>        <span class="p">(</span>
<span class="linenos">83</span>            <span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">6</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos">84</span>        <span class="p">);</span>
<span class="linenos">85</span>    <span class="p">}</span>
<span class="linenos">86</span>
<span class="linenos">87</span>
<span class="linenos">88</span>    <span class="n">frontAndBack</span>
<span class="linenos">89</span>    <span class="p">{</span>
<span class="linenos">90</span>        <span class="kt">type</span> <span class="n">empty</span><span class="p">;</span>
<span class="linenos">91</span>        <span class="k">faces</span>
<span class="linenos">92</span>        <span class="p">(</span>
<span class="linenos">93</span>            <span class="p">(</span><span class="mi">0</span> <span class="mi">3</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">94</span>            <span class="p">(</span><span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">)</span>
<span class="linenos">95</span>        <span class="p">);</span>
<span class="linenos">96</span>    <span class="p">}</span>
<span class="linenos">97</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Notice how we set the vertical and horizontal extents to 1196 and 1494, which is the pixel resolution of the image. We will scale it later to physical dimensions.</p>
<p>Now have a look at <code class="code docutils literal notranslate"><span class="pre">system/snappyHexMeshDict</span></code>. We will not go into details here, just explore the general structure yourself if you are interested using the resources linked above.</p>
<p>Time to make the mesh! Run each of the steps below individually and check out the results in paraview.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>blockMesh
snappyHexMesh -overwrite
checkMesh -allTopology -allGeometry
transformPoints -scale <span class="s2">&quot;(1e-6 1e-6 1e-6)&quot;</span>
</pre></div>
</div>
<p>The final conversion turns everything in micrometer (<span class="math notranslate nohighlight">\(10^{-6} m\)</span>). Check out the final mesh in paraview!</p>
</section>
<section id="boundary-conditions">
<h3>Boundary conditions<a class="headerlink" href="#boundary-conditions" title="Permalink to this headline"></a></h3>
<p>Next we need to set boundary conditions. Our “rock” sample is 1196 and 1494 <span class="math notranslate nohighlight">\(\mu m\)</span> and we will apply a constant pressure drop of 1 Pa. We will further use openFOAM’s <strong>simpleFoam</strong> solver, which resolves incompressible steady-state flow. One important thing to remember is that openFOAM uses the <em>kinematic</em> pressure in incompressible simulations, which is the pressure divided by density. If we assume that water with a density of <span class="math notranslate nohighlight">\(1000kg/m^3\)</span> is flowing through our smaple, we will need to set a constant pressure value of <span class="math notranslate nohighlight">\(P_{left}=0.001 m^2/s^2\)</span>. The pressure on the right-hand side will be set to zero.</p>
<p>Open the file p inside the 0 directory from your local left-hand shell.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>code <span class="m">0</span>/p
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="lst-drp-bc-p">
<div class="code-block-caption"><span class="caption-number">Listing 13 </span><span class="caption-text">Boundary conditions</span><a class="headerlink" href="#lst-drp-bc-p" title="Permalink to this code"></a></div>
<div class="highlight-foam notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*--------------------------------*- C++ -*----------------------------------*\</span>
<span class="linenos"> 2</span><span class="cm">=========                 |</span>
<span class="linenos"> 3</span><span class="cm">\\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox</span>
<span class="linenos"> 4</span><span class="cm"> \\    /   O peration     | Website:  https://openfoam.org</span>
<span class="linenos"> 5</span><span class="cm">  \\  /    A nd           | Version:  7</span>
<span class="linenos"> 6</span><span class="cm">   \\/     M anipulation  |</span>
<span class="linenos"> 7</span><span class="cm">\*---------------------------------------------------------------------------*/</span>
<span class="linenos"> 8</span><span class="k">FoamFile</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span>    <span class="kt">version</span>     <span class="mf">2.0</span><span class="p">;</span>
<span class="linenos">11</span>    <span class="kt">format</span>      <span class="k">ascii</span><span class="p">;</span>
<span class="linenos">12</span>    <span class="kt">class</span>       <span class="n">volScalarField</span><span class="p">;</span>
<span class="linenos">13</span>    <span class="kt">location</span>    <span class="s">&quot;0&quot;</span><span class="p">;</span>
<span class="linenos">14</span>    <span class="kt">object</span>      <span class="k">p</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">}</span>
<span class="linenos">16</span><span class="c1">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span>
<span class="linenos">17</span>
<span class="hll"><span class="linenos">18</span><span class="kt">dimensions</span>      <span class="p">[</span><span class="mi">0</span> <span class="mi">2</span> <span class="o">-</span><span class="mi">2</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">];</span>
</span><span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">internalField</span>   <span class="k">uniform</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="k">boundaryField</span>
<span class="linenos">23</span><span class="p">{</span>
<span class="linenos">24</span>    <span class="n">top</span>
<span class="linenos">25</span>    <span class="p">{</span>
<span class="linenos">26</span>        <span class="kt">type</span>            <span class="n">symmetryPlane</span><span class="p">;</span>
<span class="linenos">27</span>    <span class="p">}</span>
<span class="linenos">28</span>    <span class="n">inlet</span>
<span class="linenos">29</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">30</span>        <span class="kt">type</span>            <span class="k">fixedValue</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">31</span>        <span class="kt">value</span>           <span class="k">uniform</span> <span class="mf">0.001</span><span class="p">;</span>
</span><span class="linenos">32</span>    <span class="p">}</span>
<span class="linenos">33</span>    <span class="n">bottom</span>
<span class="linenos">34</span>    <span class="p">{</span>
<span class="linenos">35</span>        <span class="kt">type</span>            <span class="n">symmetryPlane</span><span class="p">;</span>
<span class="linenos">36</span>    <span class="p">}</span>
<span class="linenos">37</span>    <span class="n">outlet</span>
<span class="linenos">38</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">39</span>        <span class="kt">type</span>            <span class="k">fixedValue</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">40</span>        <span class="kt">value</span>           <span class="k">uniform</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="linenos">41</span>    <span class="p">}</span>
<span class="linenos">42</span>    <span class="n">solids</span>
<span class="linenos">43</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">44</span>        <span class="kt">type</span>            <span class="k">zeroGradient</span><span class="p">;</span>
</span><span class="linenos">45</span>    <span class="p">}</span>
<span class="linenos">46</span>    <span class="n">frontAndBack</span>
<span class="linenos">47</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">48</span>        <span class="kt">type</span>            <span class="n">empty</span><span class="p">;</span>
</span><span class="linenos">49</span>    <span class="p">}</span>
<span class="linenos">50</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>The boundary conditions are again set for the patches that were defined in the blockMeshDict. Notice how the sides have constant values. The top and bottom are symmetry planes and the internal boundaries with the solid grains get a <code class="code docutils literal notranslate"><span class="pre">zeroGradient</span></code> condition. As we are performing a 2-D simulations, the frontAndBack faces are set to <code class="code docutils literal notranslate"><span class="pre">empty</span></code>.</p>
<p>Remember that units are set by the dimensions keyword. The entries refer to the standard SI units [Kg m s K mol A cd]. By having a 2 in the second and third column, we get the correct units for the kinematic pressure.</p>
<p>We also need to set boundary conditions for the velocity.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>code <span class="m">0</span>/U
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="lst-drp-bc-u">
<div class="code-block-caption"><span class="caption-number">Listing 14 </span><span class="caption-text">Boundary conditions</span><a class="headerlink" href="#lst-drp-bc-u" title="Permalink to this code"></a></div>
<div class="highlight-foam notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*--------------------------------*- C++ -*----------------------------------*\</span>
<span class="linenos"> 2</span><span class="cm">=========                 |</span>
<span class="linenos"> 3</span><span class="cm">\\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox</span>
<span class="linenos"> 4</span><span class="cm"> \\    /   O peration     | Website:  https://openfoam.org</span>
<span class="linenos"> 5</span><span class="cm">  \\  /    A nd           | Version:  7</span>
<span class="linenos"> 6</span><span class="cm">   \\/     M anipulation  |</span>
<span class="linenos"> 7</span><span class="cm">\*---------------------------------------------------------------------------*/</span>
<span class="linenos"> 8</span><span class="k">FoamFile</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span>    <span class="kt">version</span>     <span class="mf">2.0</span><span class="p">;</span>
<span class="linenos">11</span>    <span class="kt">format</span>      <span class="k">ascii</span><span class="p">;</span>
<span class="linenos">12</span>    <span class="kt">class</span>       <span class="n">volVectorField</span><span class="p">;</span>
<span class="linenos">13</span>    <span class="kt">location</span>    <span class="s">&quot;0&quot;</span><span class="p">;</span>
<span class="linenos">14</span>    <span class="kt">object</span>      <span class="n">U</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">}</span>
<span class="linenos">16</span><span class="c1">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="kt">dimensions</span>      <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">];</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">internalField</span>   <span class="nf">uniform</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">);</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="k">boundaryField</span>
<span class="linenos">23</span><span class="p">{</span>
<span class="linenos">24</span>    <span class="n">top</span>
<span class="linenos">25</span>    <span class="p">{</span>
<span class="linenos">26</span>        <span class="kt">type</span>            <span class="n">symmetryPlane</span><span class="p">;</span>
<span class="linenos">27</span>    <span class="p">}</span>
<span class="linenos">28</span>    <span class="n">inlet</span>
<span class="linenos">29</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">30</span>        <span class="kt">type</span>            <span class="k">zeroGradient</span><span class="p">;</span>
</span><span class="linenos">31</span>    <span class="p">}</span>
<span class="linenos">32</span>    <span class="n">bottom</span>
<span class="linenos">33</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">34</span>        <span class="kt">type</span>            <span class="n">symmetryPlane</span><span class="p">;</span>
</span><span class="linenos">35</span>    <span class="p">}</span>
<span class="linenos">36</span>    <span class="n">outlet</span>
<span class="linenos">37</span>    <span class="p">{</span>
<span class="linenos">38</span>        <span class="kt">type</span>            <span class="k">zeroGradient</span><span class="p">;</span>
<span class="linenos">39</span>    <span class="p">}</span>
<span class="linenos">40</span>    <span class="n">solids</span>
<span class="linenos">41</span>    <span class="p">{</span>
<span class="hll"><span class="linenos">42</span>        <span class="kt">type</span>            <span class="n">noSlip</span><span class="p">;</span>
</span><span class="linenos">43</span>    <span class="p">}</span>
<span class="linenos">44</span>    <span class="n">frontAndBack</span>
<span class="linenos">45</span>    <span class="p">{</span>
<span class="linenos">46</span>        <span class="kt">type</span>            <span class="n">empty</span><span class="p">;</span>
<span class="linenos">47</span>    <span class="p">}</span>
<span class="linenos">48</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>The top and bottom are again symmetry planes and the <code class="code docutils literal notranslate"><span class="pre">zeroGradient</span></code> condition ensure that fluids can freely flow in and out. The contacts with the solid grains get <code class="code docutils literal notranslate"><span class="pre">noSlip</span></code>, which makes the velocity go to zero; frontAndBack are again set tp <code class="code docutils literal notranslate"><span class="pre">empty</span></code>.</p>
</section>
<section id="transport-properties">
<h3>Transport properties<a class="headerlink" href="#transport-properties" title="Permalink to this headline"></a></h3>
<p>Final step is to set the remaining free parameter (viscosity) in <a class="reference internal" href="intro.html#equation-eq-mom-con">equation (5)</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>code constant/transportProperties
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="lst-drp-tp">
<div class="code-block-caption"><span class="caption-number">Listing 15 </span><span class="caption-text">Transport properties</span><a class="headerlink" href="#lst-drp-tp" title="Permalink to this code"></a></div>
<div class="highlight-foam notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*--------------------------------*- C++ -*----------------------------------*\</span>
<span class="linenos"> 2</span><span class="cm">=========                 |</span>
<span class="linenos"> 3</span><span class="cm">\\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox</span>
<span class="linenos"> 4</span><span class="cm"> \\    /   O peration     | Website:  https://openfoam.org</span>
<span class="linenos"> 5</span><span class="cm">  \\  /    A nd           | Version:  7</span>
<span class="linenos"> 6</span><span class="cm">   \\/     M anipulation  |</span>
<span class="linenos"> 7</span><span class="cm">\*---------------------------------------------------------------------------*/</span>
<span class="linenos"> 8</span><span class="k">FoamFile</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span>    <span class="kt">version</span>     <span class="mf">2.0</span><span class="p">;</span>
<span class="linenos">11</span>    <span class="kt">format</span>      <span class="k">ascii</span><span class="p">;</span>
<span class="linenos">12</span>    <span class="kt">class</span>       <span class="k">dictionary</span><span class="p">;</span>
<span class="linenos">13</span>    <span class="kt">object</span>      <span class="k">transportProperties</span><span class="p">;</span>
<span class="linenos">14</span><span class="p">}</span>
<span class="linenos">15</span><span class="c1">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span>
<span class="linenos">16</span>
<span class="hll"><span class="linenos">17</span><span class="n">transportModel</span>  <span class="n">Newtonian</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">18</span>
</span><span class="hll"><span class="linenos">19</span><span class="n">nu</span>              <span class="p">[</span><span class="mi">0</span> <span class="mi">2</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span> <span class="mf">1e-06</span><span class="p">;</span>
</span><span class="linenos">20</span>
<span class="linenos">21</span><span class="c1">// ************************************************************************* //</span>
</pre></div>
</div>
</div>
<p>Again, in incompressible simulations (where we can divide the momentum balance equation by density) the kinematic viscosity is used, which has units of <span class="math notranslate nohighlight">\(m^2/s\)</span>. The value of <span class="math notranslate nohighlight">\(1e{-6} m^2/s\)</span> with an assumed density of <span class="math notranslate nohighlight">\(1000kg/m^3\)</span> is <span class="math notranslate nohighlight">\(1 mPa\)</span> - a typical value for water at room temperature.</p>
</section>
<section id="case-control">
<h3>Case control<a class="headerlink" href="#case-control" title="Permalink to this headline"></a></h3>
<p>Finally, we need to set some control parameters in <code class="code docutils literal notranslate"><span class="pre">system/controlDict</span></code>. Open it and explore the values.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>code system/controlDict
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="lst-drp-cdict">
<div class="code-block-caption"><span class="caption-number">Listing 16 </span><span class="caption-text">controlDict of the DRP case.</span><a class="headerlink" href="#lst-drp-cdict" title="Permalink to this code"></a></div>
<div class="highlight-foam notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*--------------------------------*- C++ -*----------------------------------*\</span>
<span class="linenos"> 2</span><span class="cm">=========                 |</span>
<span class="linenos"> 3</span><span class="cm">\\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox</span>
<span class="linenos"> 4</span><span class="cm"> \\    /   O peration     | Website:  https://openfoam.org</span>
<span class="linenos"> 5</span><span class="cm">  \\  /    A nd           | Version:  7</span>
<span class="linenos"> 6</span><span class="cm">   \\/     M anipulation  |</span>
<span class="linenos"> 7</span><span class="cm">\*---------------------------------------------------------------------------*/</span>
<span class="linenos"> 8</span><span class="k">FoamFile</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span>    <span class="kt">version</span>     <span class="mf">2.0</span><span class="p">;</span>
<span class="linenos">11</span>    <span class="kt">format</span>      <span class="k">ascii</span><span class="p">;</span>
<span class="linenos">12</span>    <span class="kt">class</span>       <span class="k">dictionary</span><span class="p">;</span>
<span class="linenos">13</span>    <span class="kt">object</span>      <span class="k">controlDict</span><span class="p">;</span>
<span class="linenos">14</span><span class="p">}</span>
<span class="linenos">15</span><span class="c1">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span>
<span class="hll"><span class="linenos">16</span>
</span><span class="linenos">17</span><span class="kt">application</span>     <span class="n">simpleFoam</span><span class="p">;</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="kt">startFrom</span>       <span class="kt">startTime</span><span class="p">;</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="kt">startTime</span>       <span class="mi">0</span><span class="p">;</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="kt">stopAt</span>          <span class="kt">endTime</span><span class="p">;</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="kt">endTime</span>         <span class="mi">1500</span><span class="p">;</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="kt">deltaT</span>          <span class="mi">1</span><span class="p">;</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="kt">writeControl</span>    <span class="n">timeStep</span><span class="p">;</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="kt">writeInterval</span>   <span class="mi">1500</span><span class="p">;</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="kt">purgeWrite</span>      <span class="mi">0</span><span class="p">;</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="kt">writeFormat</span>     <span class="k">ascii</span><span class="p">;</span>
<span class="linenos">36</span>
<span class="hll"><span class="linenos">37</span><span class="kt">writePrecision</span>  <span class="mi">9</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">38</span>
</span><span class="linenos">39</span><span class="kt">writeCompression</span> <span class="k">off</span><span class="p">;</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="kt">timeFormat</span>      <span class="k">general</span><span class="p">;</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="kt">timePrecision</span>   <span class="mi">6</span><span class="p">;</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="kt">runTimeModifiable</span> <span class="nb">true</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>The solver is a stead-state solver, so that the settings are quite simple with respect to transient simulations.</p>
</section>
<section id="running-the-case">
<h3>Running the case<a class="headerlink" href="#running-the-case" title="Permalink to this headline"></a></h3>
<p>Now we are finally ready to run the case! Just type this into your docker shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./run.sh
</pre></div>
</div>
<p>or, if you did the steps above by hand:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>simpleFoam
</pre></div>
</div>
<p>Notice how one new directory is appearing, which contains the steady-state solution. Check that the solution has converged by looking at the <code class="code docutils literal notranslate"><span class="pre">log.simpleFoam</span></code> file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tail -15 tail -15 log.simpleFoam

<span class="nv">Time</span> <span class="o">=</span> <span class="m">537</span>

smoothSolver:  Solving <span class="k">for</span> Ux, Initial <span class="nv">residual</span> <span class="o">=</span> <span class="m">9</span>.48718063e-10, Final <span class="nv">residual</span> <span class="o">=</span> <span class="m">9</span>.48718063e-10, No Iterations <span class="m">0</span>
smoothSolver:  Solving <span class="k">for</span> Uy, Initial <span class="nv">residual</span> <span class="o">=</span> <span class="m">9</span>.93804308e-10, Final <span class="nv">residual</span> <span class="o">=</span> <span class="m">9</span>.93804308e-10, No Iterations <span class="m">0</span>
GAMG:  Solving <span class="k">for</span> p, Initial <span class="nv">residual</span> <span class="o">=</span> <span class="m">9</span>.71539045e-09, Final <span class="nv">residual</span> <span class="o">=</span> <span class="m">9</span>.71539045e-09, No Iterations <span class="m">0</span>
<span class="nb">time</span> step continuity errors : sum <span class="nb">local</span> <span class="o">=</span> <span class="m">7</span>.1290424e-07, <span class="nv">global</span> <span class="o">=</span> -1.41776643e-07, <span class="nv">cumulative</span> <span class="o">=</span> <span class="m">3</span>.8954571
<span class="nv">ExecutionTime</span> <span class="o">=</span> <span class="m">30</span>.24 s  <span class="nv">ClockTime</span> <span class="o">=</span> <span class="m">30</span> s


SIMPLE solution converged <span class="k">in</span> <span class="m">537</span> iterations

End
</pre></div>
</div>
<p>And explore the solution in Paraview!</p>
<figure class="align-center" id="fig-porousmodel-solution-fig" style="width: 100%">
<img alt="../../_images/paraview_DRP_solution.png" src="../../_images/paraview_DRP_solution.png" />
<figcaption>
<p><span class="caption-number">Fig. 14 </span><span class="caption-text">Predicted velocity field.</span><a class="headerlink" href="#fig-porousmodel-solution-fig" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="post-processing-effective-permeability">
<h3>Post-processing / Effective permeability<a class="headerlink" href="#post-processing-effective-permeability" title="Permalink to this headline"></a></h3>
<p>Time to get back to our initial objective. What is the predicted permeability of our sample? We need to postprocess our solution and solve <a class="reference internal" href="#equation-eq-darcy-perm">equation (7)</a>, which requires are few intermediate steps. First, we need to compute the cell volumes, so that we can integrate the velocity over the total volume. Here comes openFOAM’s <a class="reference external" href="https://cfd.direct/openfoam/user-guide/v7-post-processing-cli/">postProcess</a> functionality handy. Just do this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>postProcess -func writeCellVolumes
</pre></div>
</div>
<p>This will create a new variable <span class="math notranslate nohighlight">\(V\)</span> in in the output directories, which is the volume of each cell. Next we can save the full solution as a vtk file, so that we can postprocess it with python.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>foamToVTK -useTimeName -latestTime -poly
</pre></div>
</div>
<p>Check that a new <code class="code docutils literal notranslate"><span class="pre">VTK</span></code> directory was created. Now we are ready for some more fancy post-processing using python.</p>
<p>Here is an example script for computing permeability. You can turn it into a jupyter notebook or save it as a .py file into your case directory and run it from there.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vtk.util</span> <span class="kn">import</span> <span class="n">numpy_support</span> <span class="k">as</span> <span class="n">VN</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># load VTK data</span>
<span class="n">vtkFile</span> <span class="o">=</span> <span class="s1">&#39;VTK/DRP_permeability_2D_537.vtk&#39;</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkUnstructuredGridReader</span><span class="p">()</span>
<span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtkFile</span><span class="p">)</span>
<span class="n">reader</span><span class="o">.</span><span class="n">ReadAllScalarsOn</span><span class="p">()</span>
<span class="n">reader</span><span class="o">.</span><span class="n">ReadAllVectorsOn</span><span class="p">()</span>
<span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>


<span class="c1"># extract velocity arrays</span>
<span class="n">Vcells</span> <span class="o">=</span> <span class="n">VN</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">))</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">VN</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">))</span>
<span class="n">Umag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Ux</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Uy</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Uz</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># calculate volume fluxes</span>
<span class="n">qx</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">qy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vcells</span><span class="p">)):</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">Vcells</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ux</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">q2</span> <span class="o">=</span> <span class="n">Vcells</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">Uy</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">qx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">qy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>

<span class="c1"># simulation parameters</span>
<span class="n">DP</span> <span class="o">=</span> <span class="mi">1</span>                       <span class="c1"># pressure drop [Pa]</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mf">1e-06</span>                   <span class="c1"># kinematic viscosity [m²/s²]</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mi">1000</span>                   <span class="c1"># density [kg/m³]</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">rho</span>                <span class="c1"># dynamic viscosity [kg/(m*s)]</span>
<span class="n">dx</span> <span class="o">=</span> <span class="mf">0.001196</span>                <span class="c1"># model length x [m]</span>
<span class="n">dy</span> <span class="o">=</span> <span class="mf">0.001494</span>                <span class="c1"># model width y [m]</span>
<span class="n">dz</span> <span class="o">=</span> <span class="mf">1e-6</span>                    <span class="c1"># model thickness z [m]</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dz</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">A</span>

<span class="c1"># calculate Darcy velocity</span>
<span class="n">U_Darcy_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">qx</span><span class="p">)</span><span class="o">/</span><span class="n">V</span>

<span class="n">kxx</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">U_Darcy_x</span><span class="o">/</span><span class="n">DP</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bulk permeability: </span><span class="si">%5.3e</span><span class="s1"> m2&#39;</span> <span class="o">%</span> <span class="n">kxx</span><span class="p">)</span>
</pre></div>
</div>
<p>We made it! <span class="math notranslate nohighlight">\(2.71e^{-11} m^2\)</span> is our predicted effective permeability of our sample.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="intro.html" class="btn btn-neutral float-left" title="Digital Rock Physics - Effective Permeability of Rocks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Exercise.html" class="btn btn-neutral float-right" title="Exercises" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Lars Ruepke and Zhikui Guo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>