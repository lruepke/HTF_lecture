
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coupled diffusion problems &mdash; Finite Element Modeling in Geodynamics  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/tabs.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Turing pattern using FDM." href="jupyter/turing_fdm.html" />
    <link rel="prev" title="Transient heat diffusion" href="transient_problems.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Finite Element Modeling in Geodynamics
            <img src="../_static/htf_picto2.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Course information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general-info/course-details.html">Course details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general-info/installation.html">Installation guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lecture1/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture1/fdm_intro.html">Introduction: The Finite Differences Method (FDM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture1/example_1.html">Example 1: Cooling dike</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture1/example_2.html">Example 2: Cooling dike - implicit version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture1/example_3.html">Example 3: Periodic variations in seafloor temperature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture1/fdm_advection.html">Transport problems with FDM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lecture2/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture2/mwr_intro.html">Introduction: Method of Weighted Residuals (MWR)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture2/mwr_examples.html">MWR solutions of the steady advection-diffusion equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture2/excercises.html">Excercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lecture3/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture3/fem_intro.html">Introduction Finite Element Method (FEM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture3/fem_intro.html#fem-implementation">FEM implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture3/fem_advection.html">FEM and advection problems</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 4</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lecture4/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture4/fem_in_2d.html">2-D FEM - elliptic problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture4/fem_in_2d.html#implementation">Implementation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 5</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lecture5/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture5/FEM_triangles.html">Triangles: unstructured meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture5/FEM_triangles.html#excercise">Excercise</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 6</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="transient_problems.html">Transient heat diffusion</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Coupled diffusion problems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#governing-equations">Governing equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fem-discretization">FEM discretization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-linear-terms">Non-linear terms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-implementation">Python implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#excercise">Excercise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#is-fem-a-good-idea-for-solving-this-problem">Is FEM a good idea for solving this problem?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="jupyter/turing_fdm.html">Turing pattern using FDM.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../refs.html">References</a></li>
</ul>


    
        <p class="caption">
            <span class="caption-text">Getting help</span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="mailto:lruepke@geomar.de"><i class="fa fa-envelope fa-fw"></i> Prof. Lars Ruepke</a></li>
            
                <li class="toctree-l1"><a href="mailto:zguo@geomar.de"><i class="fa fa-envelope fa-fw"></i> Dr. Zhikui Guo</a></li>
            
                <li class="toctree-l1"><a href="https://lruepke.github.io/FEM_lecture/"><i class="fa fa-home fa-fw"></i> Public site</a></li>
            
                <li class="toctree-l1"><a href="https://lms.uni-kiel.de/url/RepositoryEntry/3664576582"><i class="fa fa-home fa-fw"></i> University site</a></li>
            
        </ul>
    

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Finite Element Modeling in Geodynamics</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Coupled diffusion problems</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/lruepke/HTF_lecture/blob/main//source/lecture6/turing_coupled_problem.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="coupled-diffusion-problems">
<h1>Coupled diffusion problems<a class="headerlink" href="#coupled-diffusion-problems" title="Permalink to this headline"></a></h1>
<p>So far we have looked at problems that included a single unknown (e.g. temperature) at each node. Sometimes it is necessary to solve for multiple unknowns at each node simultaneously. This could just be multiple displacement or velocity components (as in mechanics), or this could be necessary when equations are strongly coupled.</p>
<p>One example, where a coupled system of equations needs to be solved are so-called Turing pattern <span id="id1">[<a class="reference internal" href="../refs.html#id36" title="A. M. Turing. The chemical basis of morphogenesis. Philosophical Transactions of the Royal Society of London Series B-Biological Sciences, 237(641):37-72, 1952. URL: &lt;Go to ISI&gt;://WOS:A1952YF90500001, doi:10.1098/rstb.1952.0012.">Turing, 1952</a>]</span>, which appear to emerge in many biological and chemical systems quasi spontaneously from near homogeneous starting conditions. A modern look at it can be found in the paper by <span id="id2">[<a class="reference internal" href="../refs.html#id37" title="Philip K. Maini, Thomas E. Woolley, Ruth E. Baker, Eamonn A. Gaffney, and S. Seirin Lee. Turing's model for biological pattern formation and the robustness problem. Interface Focus, 2(4):487-496, 2012. URL: https://doi.org/10.1098/rsfs.2011.0113, doi:10.1098/rsfs.2011.0113.">Maini et al., 2012</a>]</span>. Here we follow the implementation and problem description given in the FEM book by Guy Simpson <span id="id3">[<a class="reference internal" href="../refs.html#id31" title="Guy Simpson. Practical Finite Element Modeling in Earth Science Using Matlab. John Wiley &amp; Sons, Ltd, 2017. ISBN 9781119248644. URL: https://onlinelibrary.wiley.com/doi/abs/10.1002/9781119248644.part1, arXiv:https://onlinelibrary.wiley.com/doi/pdf/10.1002/9781119248644.part1, doi:https://doi.org/10.1002/9781119248644.part1.">Simpson, 2017</a>]</span>.</p>
<section id="governing-equations">
<h2>Governing equations<a class="headerlink" href="#governing-equations" title="Permalink to this headline"></a></h2>
<p>We will explore the evolution of two chemical compounds, <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>, which affect each other. One is an ‘activator’ and one is an ‘inhibitor’. Both compounds are also produced by a background rate and the their concentrations control each other. This can be expressed by a set of coupled equations.</p>
<div class="math notranslate nohighlight" id="equation-eq-turing-eqs">
<span class="eqno">(147)<a class="headerlink" href="#equation-eq-turing-eqs" title="Permalink to this equation"></a></span>\[\begin{split}\begin{align}
\begin{split}
\frac{\partial A}{\partial t} &amp;= \nabla^2 A + \gamma (a - A +A^2 B)\\
\frac{\partial B}{\partial t} &amp;= d\nabla^2 B + \gamma (b - A^2 B)
\end{split}
\end{align}\end{split}\]</div>
<p>In these equations, both compounds are produced at background rates <span class="math notranslate nohighlight">\(\gamma a\)</span> and <span class="math notranslate nohighlight">\(\gamma b\)</span>, <span class="math notranslate nohighlight">\(A\)</span>gamma A`, and reaction further produces the ‘ activator’ <span class="math notranslate nohighlight">\(A\)</span> resulting in a feedback that is described by the non-linear <span class="math notranslate nohighlight">\(A^2 B\)</span> term, which couples the equations in a non-trivial way.</p>
</section>
<section id="fem-discretization">
<h2>FEM discretization<a class="headerlink" href="#fem-discretization" title="Permalink to this headline"></a></h2>
<p>Using the same FD time discretization and using an implicit scheme, we can write these equations in FEM matrix form (just like we did for temperature in the previous example):</p>
<div class="math notranslate nohighlight" id="equation-eq-turing-eqs-fem">
<span class="eqno">(148)<a class="headerlink" href="#equation-eq-turing-eqs-fem" title="Permalink to this equation"></a></span>\[\begin{split}\begin{align}
\begin{split}
(M(1+\Delta t\gamma) + \Delta tA_A)A^{n+1} = MA^n + \Delta tF_A^{n+1}\\
(M + \Delta tA_B)B^{n+1} = MB^n + \Delta tF_B^{n+1}
\end{split}
\end{align}\end{split}\]</div>
<p>with the matrices defined as:</p>
<div class="math notranslate nohighlight" id="equation-eq-turing-eqs-fem-matrix">
<span class="eqno">(149)<a class="headerlink" href="#equation-eq-turing-eqs-fem-matrix" title="Permalink to this equation"></a></span>\[\begin{split}\begin{align}
\begin{split}
M &amp;= \int_\Omega N_i N_j  d\Omega \ \ \ \ \ \ \ i,j=1,2,...,n\\
A_A &amp;= \int_\Omega \left ( \frac{\partial N_i}{\partial x}\frac{\partial N_j }{\partial x} + \frac{\partial N_i}{\partial y}\frac{\partial N_j }{\partial y} d\Omega \right ) d\Omega\ \ \ \ \ \ \ i,j=1,2,...,n\\
A_B &amp;= \int_\Omega d \left ( \frac{\partial N_i}{\partial x}\frac{\partial N_j }{\partial x} + \frac{\partial N_i}{\partial y}\frac{\partial N_j }{\partial y} d\Omega \right ) d\Omega\ \ \ \ \ \ \ i,j=1,2,...,n\\
F_A &amp;= \int_\Omega \gamma N_i \left (a + (N_jA_j)^2N_jB_j      \right )  d\Omega \ \ \ \ \ \ \ i,j=1,2,...,n\\
F_B &amp;= \int_\Omega \gamma N_i \left (b - (N_jA_j)^2N_jB_j      \right )  d\Omega \ \ \ \ \ \ \ i,j=1,2,...,n\\
\end{split}
\end{align}\end{split}\]</div>
<p>We can combine the matrices on the left-hand side and get the stifness matrices <span class="math notranslate nohighlight">\(K_A\)</span> and <span class="math notranslate nohighlight">\(K_B\)</span>.</p>
<div class="math notranslate nohighlight" id="equation-eq-turing-eqs-fem-matrix-2">
<span class="eqno">(150)<a class="headerlink" href="#equation-eq-turing-eqs-fem-matrix-2" title="Permalink to this equation"></a></span>\[\begin{split}\begin{align}
\begin{split}
K_A A^{n+1} = M A^n + \Delta t F_A^{n+1}\\
K_B B^{n+1} = M B^n + \Delta t F_B^{n+1}
\end{split}
\end{align}\end{split}\]</div>
<p>Notice how we used a fully implicit scheme that evaluates the source terms at the new time level <span class="math notranslate nohighlight">\(n+1\)</span>. We we will review this design decisions later.</p>
<p>One way of solving such a coupled problem is to have two unknowns per node (two so-called degrees of freedom). In our case, the complete element stiffness matrix would look like this:</p>
<div class="math notranslate nohighlight" id="equation-eq-turing-eqs-fem-matrix-3">
<span class="eqno">(151)<a class="headerlink" href="#equation-eq-turing-eqs-fem-matrix-3" title="Permalink to this equation"></a></span>\[\begin{split}\begin{bmatrix}
{K_A}_{11} &amp; 0 &amp; {K_A}_{12} &amp; 0 &amp; {K_A}_{13} &amp; 0 \\
0 &amp; {K_B}_{11} &amp; 0 &amp; {K_B}_{12} &amp; 0 &amp; {K_B}_{13} \\
{K_A}_{21} &amp; 0 &amp; {K_A}_{22} &amp; 0 &amp; {K_A}_{23} &amp; 0 \\
0 &amp; {K_B}_{21} &amp; 0 &amp; {K_B}_{22} &amp; 0 &amp; {K_B}_{23} \\
{K_A}_{31} &amp; 0 &amp; {K_A}_{32} &amp; 0 &amp; {K_A}_{33} &amp; 0 \\
0 &amp; {K_B}_{31} &amp; 0 &amp; {K_B}_{32} &amp; 0 &amp; {K_B}_{33}
\end{bmatrix}
\begin{bmatrix}
A_1^{n+1}\\
B_1^{n+1}\\
A_2^{n+1}\\
B_2^{n+1}\\
A_3^{n+1}\\
B_3^{n+1}\\
\end{bmatrix}
= Rhs\end{split}\]</div>
<p>The unknown concentrations of <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span> or both showing up in the solution vector. What we also note is that the coupling is not that strong as there are no cross-terms. The equation for <span class="math notranslate nohighlight">\(A_1^{n+1}\)</span>, the first row in <a class="reference internal" href="#equation-eq-turing-eqs-fem-matrix-3">equation (151)</a>, has zeros in the columns that operate on B. The coupling comes in through the source terms that appear on the Rhs (<a class="reference internal" href="#equation-eq-turing-eqs">equation (147)</a>).</p>
</section>
<section id="non-linear-terms">
<h2>Non-linear terms<a class="headerlink" href="#non-linear-terms" title="Permalink to this headline"></a></h2>
<p>Treating the non-linear source term in an implicit way requires iterations - because the term <span class="math notranslate nohighlight">\(A^2B\)</span> and <span class="math notranslate nohighlight">\(B\)</span>, then update the source terms, and solve again until the solution is converged. Easiest to implement would be a non-linear iteration loop over the entire element loop but that would not be very smart as the stiffness matrix is not changing during iterations. Instead we first assembly the stiffness matrix and then have an iteration loop that updates the source term (right-hand side) until the solution is converged.</p>
</section>
<section id="python-implementation">
<h2>Python implementation<a class="headerlink" href="#python-implementation" title="Permalink to this headline"></a></h2>
<p>We take our transient triangle solver from the previous excercise as a starting point and just modify the mesh and equation assembly, and add the non-linear iterations.</p>
<dl class="simple">
<dt>The model parameters are:</dt><dd><ul class="simple">
<li><p>x,y have length 5</p></li>
<li><p>diffusivity for <span class="math notranslate nohighlight">\(B\)</span> is <span class="math notranslate nohighlight">\(d=20\)</span></p></li>
<li><p>diffusivity for <span class="math notranslate nohighlight">\(A\)</span> is <span class="math notranslate nohighlight">\(1\)</span></p></li>
<li><p>we use a triangle size of 0.005</p></li>
<li><dl class="simple">
<dt>and the other constants are:</dt><dd><ul>
<li><p><span class="math notranslate nohighlight">\(\gamma=600\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(a=0.05\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(b=1\)</span></p></li>
<li><p>time step is <span class="math notranslate nohighlight">\(\Delta t=5e^{-4}\)</span></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
<p>Key pieces of the code are:</p>
<div class="literal-block-wrapper docutils container" id="lst-2d-fem-turing-3">
<div class="code-block-caption"><span class="caption-number">Listing 5 </span><span class="caption-text">Initial conditions</span><a class="headerlink" href="#lst-2d-fem-turing-3" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nnodel</span> <span class="o">=</span> <span class="n">EL2NOD</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">nel</span>    <span class="o">=</span> <span class="n">EL2NOD</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">nnod</span>   <span class="o">=</span> <span class="n">GCOORD</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sdof</span>   <span class="o">=</span> <span class="n">nnod</span><span class="o">*</span><span class="mi">2</span>                 <span class="c1"># two dof per node</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nnod</span><span class="p">,</span> <span class="n">nel</span><span class="p">)</span>

<span class="c1"># Initial conditions</span>
<span class="n">rng</span>  <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>
<span class="n">vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">nnod</span><span class="p">)</span>
<span class="hll"><span class="n">A</span>    <span class="o">=</span> <span class="p">(</span><span class="n">a_coeff</span><span class="o">+</span><span class="n">b_coeff</span><span class="p">)</span> <span class="o">+</span> <span class="n">amp</span><span class="o">*</span><span class="n">vals</span>
</span><span class="hll"><span class="n">vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">nnod</span><span class="p">)</span>
</span><span class="hll"><span class="n">B</span>    <span class="o">=</span> <span class="n">b_coeff</span><span class="o">/</span><span class="p">(</span><span class="n">a_coeff</span><span class="o">+</span><span class="n">b_coeff</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">amp</span><span class="o">*</span><span class="n">vals</span>
</span></pre></div>
</div>
</div>
<p>This is how the initial conditions are set using random noise. Notice also how we define a variable <code class="code docutils literal notranslate"><span class="pre">sdof</span></code> that refers to the number of equations, while <code class="code docutils literal notranslate"><span class="pre">nnod</span></code> refers to the number of nodes in the mesh.</p>
<div class="literal-block-wrapper docutils container" id="lst-2d-fem-turing-1">
<div class="code-block-caption"><span class="caption-number">Listing 6 </span><span class="caption-text">Matrix assembly</span><a class="headerlink" href="#lst-2d-fem-turing-1" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nt</span><span class="p">):</span>

<span class="c1"># Storage</span>
<span class="n">Rhs_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sdof</span><span class="p">)</span>
<span class="n">I</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nel</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">))</span>
<span class="n">J</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nel</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">))</span>
<span class="n">K</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nel</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">iel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nel</span><span class="p">):</span>
        <span class="n">ECOORD</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">GCOORD</span><span class="p">,</span> <span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
<span class="hll">        <span class="n">Ael_A</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nnodel</span><span class="p">,</span><span class="n">nnodel</span><span class="p">))</span>
</span><span class="hll">        <span class="n">Ael_B</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nnodel</span><span class="p">,</span><span class="n">nnodel</span><span class="p">))</span>
</span><span class="hll">        <span class="n">RhsA_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nnodel</span><span class="p">)</span>
</span><span class="hll">        <span class="n">RhsB_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nnodel</span><span class="p">)</span>
</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nip</span><span class="p">):</span>
            <span class="c1"># 1. update shape functions</span>
            <span class="n">xi</span>      <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eta</span>     <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">N</span><span class="p">,</span> <span class="n">dNds</span> <span class="o">=</span> <span class="n">shapes_tri</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

            <span class="c1"># 2. set up Jacobian, inverse of Jacobian, and determinant</span>
            <span class="n">Jac</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dNds</span><span class="p">,</span><span class="n">ECOORD</span><span class="p">)</span> <span class="c1">#[2,nnodel]*[nnodel,2]</span>
            <span class="n">invJ</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Jac</span><span class="p">)</span>
            <span class="n">detJ</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Jac</span><span class="p">)</span>

            <span class="c1"># 3. get global derivatives</span>
            <span class="n">dNdx</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">invJ</span><span class="p">,</span> <span class="n">dNds</span><span class="p">)</span> <span class="c1"># [2,2]*[2,nnodel]</span>

            <span class="c1"># 4. compute element stiffness matrices</span>
<span class="hll">            <span class="n">Ael_A</span>     <span class="o">=</span> <span class="n">Ael_A</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">g_coeff</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span>  <span class="n">dt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dNdx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dNdx</span><span class="p">))</span><span class="o">*</span><span class="n">detJ</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
</span><span class="hll">            <span class="n">Ael_B</span>     <span class="o">=</span> <span class="n">Ael_B</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>        <span class="o">+</span>  <span class="n">d_coeff</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dNdx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dNdx</span><span class="p">))</span><span class="o">*</span><span class="n">detJ</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
</span>
            <span class="c1"># 5. assemble right-hand side</span>
<span class="hll">            <span class="n">RhsA_el</span>     <span class="o">=</span> <span class="n">RhsA_el</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">))</span><span class="o">*</span><span class="n">detJ</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
</span><span class="hll">            <span class="n">RhsB_el</span>     <span class="o">=</span> <span class="n">RhsB_el</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">))</span><span class="o">*</span><span class="n">detJ</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
</span>
        <span class="c1"># assemble coefficients</span>
<span class="hll">        <span class="n">I</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span>  <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nnodel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nnodel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">)))</span>
</span><span class="hll">        <span class="n">J</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span>  <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nnodel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nnodel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">)))</span>
</span>        <span class="n">K</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span>  <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Ael_A</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">),</span><span class="n">Ael_B</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">)))</span>

<span class="hll">        <span class="n">Rhs_all</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]]</span>   <span class="o">+=</span> <span class="n">RhsA_el</span>
</span><span class="hll">        <span class="n">Rhs_all</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RhsB_el</span>
</span>
    <span class="n">A_all</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">K</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nel</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">),(</span><span class="n">I</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nel</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">),</span><span class="n">J</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nel</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">nnodel</span><span class="o">*</span><span class="n">nnodel</span><span class="p">))),</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sdof</span><span class="p">,</span><span class="n">sdof</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Notice how the node numbering is different to the equation numbering! Each node has two degrees of freedom, the concentration of <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>. All concentrations of <span class="math notranslate nohighlight">\(A\)</span> are stored at <code class="code docutils literal notranslate"><span class="pre">2*EL2NOD[iel,:]</span></code> for the element, iel, and the concentrations of <span class="math notranslate nohighlight">\(B\)</span> at <code class="code docutils literal notranslate"><span class="pre">2*EL2NOD[iel,:]+1</span></code>. This is a typical way of numbering the equations and we will see the same pattern when solving for viscous flow (when each node has two velocities).</p>
<div class="literal-block-wrapper docutils container" id="lst-2d-fem-turing-2">
<div class="code-block-caption"><span class="caption-number">Listing 7 </span><span class="caption-text">Non-linear iterations and solution</span><a class="headerlink" href="#lst-2d-fem-turing-2" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># update right hand side in iterations</span>

<span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">error</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">tol</span>   <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">Conc_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sdof</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
<span class="n">iter_max</span> <span class="o">=</span> <span class="mi">20</span>

<span class="hll"><span class="k">while</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span class="hll">    <span class="n">Tmp</span> <span class="o">=</span> <span class="n">Rhs_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span>    <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># loop over all elements and integrate Rhs</span>
    <span class="k">for</span> <span class="n">iel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nel</span><span class="p">):</span>
        <span class="n">FA_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nnodel</span><span class="p">)</span>
        <span class="n">FB_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nnodel</span><span class="p">)</span>
        <span class="n">ECOORD</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">GCOORD</span><span class="p">,</span> <span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nip</span><span class="p">):</span>
            <span class="c1"># 1. update shape functions</span>
            <span class="n">xi</span>      <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eta</span>     <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">N</span><span class="p">,</span> <span class="n">dNds</span> <span class="o">=</span> <span class="n">shapes_tri</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

            <span class="c1"># 2. set up Jacobian, inverse of Jacobian, and determinant</span>
            <span class="n">Jac</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dNds</span><span class="p">,</span><span class="n">ECOORD</span><span class="p">)</span> <span class="c1">#[2,nnodel]*[nnodel,2]</span>
            <span class="n">invJ</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Jac</span><span class="p">)</span>
            <span class="n">detJ</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Jac</span><span class="p">)</span>

            <span class="c1">#3. integrate force vector</span>
            <span class="n">Ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">))</span>
            <span class="n">Bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">))</span>
<span class="hll">            <span class="n">FA_el</span>     <span class="o">=</span> <span class="n">FA_el</span> <span class="o">+</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">g_coeff</span><span class="o">*</span><span class="p">(</span><span class="n">a_coeff</span><span class="o">+</span><span class="n">Bi</span><span class="o">*</span><span class="n">Ai</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">detJ</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="c1"># (dt*g_coeff*N*a_coeff+dt*g_coeff*N*np.dot(N,np.take(A, EL2NOD[iel,:], axis=0 ))**2*np.dot(N,np.take(B, EL2NOD[iel,:], axis=0 )))*detJ*weights[ip]</span>
</span><span class="hll">            <span class="n">FB_el</span>     <span class="o">=</span> <span class="n">FB_el</span> <span class="o">+</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">g_coeff</span><span class="o">*</span><span class="p">(</span><span class="n">b_coeff</span><span class="o">-</span><span class="n">Bi</span><span class="o">*</span><span class="n">Ai</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">detJ</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="c1"># (dt*g_coeff*N*b_coeff-dt*g_coeff*N*np.dot(N,np.take(A, EL2NOD[iel,:], axis=0 ))**2*np.dot(N,np.take(B, EL2NOD[iel,:], axis=0 )))*detJ*weights[ip]</span>
</span>
        <span class="c1"># We don&#39;t have boundary conditions, as everything is zero flux</span>
<span class="hll">        <span class="n">Tmp</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]]</span>   <span class="o">+=</span> <span class="n">FA_el</span>
</span><span class="hll">        <span class="n">Tmp</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">EL2NOD</span><span class="p">[</span><span class="n">iel</span><span class="p">,:]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">FB_el</span>
</span>
    <span class="c1"># solve  system</span>
<span class="hll">    <span class="n">Conc</span>  <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">A_all</span><span class="p">,</span><span class="n">Tmp</span><span class="p">)</span>
</span><span class="hll">    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">Conc</span> <span class="o">-</span> <span class="n">Conc_tmp</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">Conc</span><span class="p">))</span>
</span><span class="hll">    <span class="n">Conc_tmp</span> <span class="o">=</span> <span class="n">Conc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span class="hll">    <span class="n">A</span>     <span class="o">=</span> <span class="n">Conc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">sdof</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span class="hll">    <span class="n">B</span>     <span class="o">=</span> <span class="n">Conc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">sdof</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">iter</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">iter</span> <span class="o">==</span> <span class="n">iter_max</span><span class="p">:</span>

        <span class="k">break</span>
</pre></div>
</div>
</div>
<p>During the non-linear iterations, which happen inside the time loop, we keep changing the right-hand side and solve the system of equations. We do not re-assembly the stiffness matrix as it actually doesn’t change during itreations. It actually also doesn’t change during time steps and we could optimize the code further.</p>
</section>
<section id="excercise">
<h2>Excercise<a class="headerlink" href="#excercise" title="Permalink to this headline"></a></h2>
<p>Try to puzzle a working code together and make sure that you understand the equation numbering and the way the iterations are done. If you get bored, stuck, or impatient: here is a link to the working code <a class="reference download internal" download="" href="../_downloads/980edd14512accd895dbf2deca82dfd1/double_diff.py"><code class="xref download docutils literal notranslate"><span class="pre">double_diff.py</span></code></a>.</p>
<p>Results of transient Turing problem.</p>
<video width=100% autoplay muted controls loop>
<source src="../_static/video/Turing.mp4" type="video/mp4">
   Your browser does not support HTML video.
</video></section>
<section id="is-fem-a-good-idea-for-solving-this-problem">
<h2>Is FEM a good idea for solving this problem?<a class="headerlink" href="#is-fem-a-good-idea-for-solving-this-problem" title="Permalink to this headline"></a></h2>
<p>Ok, we got it to work but the solution seems super slow. We iterate to get a consistent right-hand side and solve the equations on an unstructured mesh although we are not resolving any complex geometries.</p>
<p>A closer look at the equations also reveals that we are solving a problem that is dominated by the source terms (the reactions rates). Such problems are always a bit tricky to solve as the reactions often take please at faster rates than the diffusion process. As a consequence, we actually struggle to take big time steps and our fully implicit scheme is not efficient.</p>
<p>A much more effective way to solve the equations is to use explicit methods that are time-step limited (remember the FDM lectures?) but are also very efficient as they do not involve solving a system of equations.</p>
<p>To illustrate this point, we look at a Turing problem that is described <a class="reference external" href="https://blogs.mathworks.com/graphics/2015/03/16/how-the-tiger-got-its-stripes/">here</a> and <a class="reference external" href="http://www.karlsims.com/rd.html">here</a> . Read those linked documents - they provide a really nice introduction to Turing pattern!</p>
<p>Alright, back to explicit FDM, let’s see how badly FEM on unstructured meshes “loses” against FDM on a structured mesh. Have a look at the notebook and complete it! Try also other variations of “kill” and “feed” parameters.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="jupyter/turing_fdm.html">Turing pattern using FDM.</a></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="transient_problems.html" class="btn btn-neutral float-left" title="Transient heat diffusion" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="jupyter/turing_fdm.html" class="btn btn-neutral float-right" title="Turing pattern using FDM." accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Lars Ruepke and Zhikui Guo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
      
        <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
          <span class="rst-current-version" data-toggle="rst-current-version">
            <span class="fa fa-book"> Finite Element Modeling in Geodynamics</span>
            v: latest
            <span class="fa fa-caret-down"></span>
          </span>
          <div class="rst-other-versions">
            <dl>
              
                
                <dd><a href="https://lruepke.github.io/FEM_lecture/downloads/LectureNote.pdf">latest</a></dd>
                
                <dd><a href="#/LectureNote.pdf">2.0</a></dd>
                
              
          </div>
        </div>
      
    

</body>
</html>