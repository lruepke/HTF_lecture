
<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FVM and OpenFoam &mdash; HydrothermalFoam Lecture  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=3d3fbe02" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=379f3234" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/tabs.js?v=3ee01567"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="OpenFoam implementation" href="Implementation1.html" />
    <link rel="prev" title="Lecture overview" href="Overview.html" /> 
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EJ32EEFYRN"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EJ32EEFYRN');
    </script>   

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            HydrothermalFoam Lecture
              <img src="../../_static/DRP_vert_cover.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Course information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general-info/course-details.html">Course details</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L01/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L01/Installation.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L01/OpenFoam.html">Getting started with OpenFoam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L01/FirstCase.html">A first test case - heat diffusion</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L02/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L02/Example.html">Navier-Stokes flow with OpenFoam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L02/Exercise.html">Excercise</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L03/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L03/intro.html">Digital Rock Physics - Effective Permeability of Rocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L03/FirstCase.html">Flow on the pore scale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L03/Exercise.html">Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L03/Theory.html">Theoretical background</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 4</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L04/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L04/intro.html">Porous Flow - Submarine Hydrothermal Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L04/FirstCase.html">Hydrothermal convection test case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L04/Exercise.html">Excercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 5</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L05/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/intro.html">Upflow temperatures in submarine hydrothermal systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/Exercise1.html">Exercise 1: Fluid properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/Exercise2.html">Exercise 2: Fluxibility and Tvent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L05/Exercise3.html">Exercise 3: Permeability and Tvent</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 6</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L06/Overview.html">Lecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L06/intro.html">Structural controls on hydrothermal flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L06/Exercise1.html">Exercise 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L06/Exercise2.html">Exercise 2</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Lecture 7</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Lecture overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FVM and OpenFoam</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic-concept">Basic Concept</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-problem-heat-diffusion">Example problem: heat diffusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geometry-and-governing-equations">Geometry and governing equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#domain-discretization">Domain discretization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mesh-structure-and-topology">Mesh structure and topology</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-discretization-the-diffusion-term">Spatial discretization: The diffusion term</a></li>
<li class="toctree-l2"><a class="reference internal" href="#temporal-discretization-the-transient-term">Temporal Discretization: The Transient Term</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#first-order-implicit-euler-scheme">First order implicit Euler scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="#first-order-explicit-euler-scheme">First order explicit Euler scheme</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#building-the-matrix-mesh-connectivity-and-internal-data-storage">Building the matrix: Mesh connectivity and internal data storage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Implementation1.html">OpenFoam implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Advection1.html">The advection term</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L_PROJECTS/Project1.html">Project 1: Flow along a detachment fault</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L_PROJECTS/Project2.html">Project 2: How long can a magmatic intrusion sustain high temperature venting?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L_PROJECTS/Project3.html">Project 3: Hydrofracturing and localized venting above sill intrusion?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../refs.html">References</a></li>
</ul>


    
        <p class="caption">
            <span class="caption-text">Getting help</span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="https://lruepke.github.io/HTF_lecture/imprint/"><i class="fa fa-stamp"></i> Imprint</a></li>
            
                <li class="toctree-l1"><a href="mailto:lruepke@geomar.de"><i class="fa fa-envelope fa-fw"></i> Prof. Lars Ruepke</a></li>
            
                <li class="toctree-l1"><a href="mailto:zguo@geomar.de"><i class="fa fa-envelope fa-fw"></i> Dr. Zhikui Guo</a></li>
            
                <li class="toctree-l1"><a href="https://www.hydrothermalfoam.info"><i class="fa fa-gitlab fa-fw"></i> HydrothermalFoam</a></li>
            
                <li class="toctree-l1"><a href="https://www.openfoam.org"><i class="fa fa-github fa-fw"></i> OpenFOAM</a></li>
            
                <li class="toctree-l1"><a href="https://lruepke.github.io/HTF_lecture/"><i class="fa fa-home fa-fw"></i> Public site</a></li>
            
                <li class="toctree-l1"><a href="https://lms.uni-kiel.de/url/RepositoryEntry/3664576582"><i class="fa fa-home fa-fw"></i> University site</a></li>
            
        </ul>
    

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">HydrothermalFoam Lecture</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">FVM and OpenFoam</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/lruepke/HTF_lecture/blob/main/Summer2022/source/lectures/L_FVM/intro.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="fvm-and-openfoam">
<span id="l-fvm-intro"></span><h1>FVM and OpenFoam<a class="headerlink" href="#fvm-and-openfoam" title="Link to this heading"></a></h1>
<p>In the previous session, we have used openFoam to resolve hydrothermal convection in oceanic crust. In this lecture, we will have a deeper look into how openFoam solves the governing equations and how the numerical schemes work.</p>
<p>OpenFoam uses the Finite Volume Method (FVM), which is a popular numerical technique used in computational fluid dynamics (CFD) and other areas of computational physics to solve partial differential equations (PDEs) that describe physical phenomena. It’s particularly well-suited for problems involving fluid flow, heat transfer, and associated physical processes. Here’s an overview of how FVM works:</p>
<section id="basic-concept">
<h2>Basic Concept<a class="headerlink" href="#basic-concept" title="Link to this heading"></a></h2>
<p><strong>Domain Discretization</strong> The computational domain (the area or volume where the physical problem occurs) is divided into small, discrete control volumes (cells). These control volumes cover the entire domain without overlapping.</p>
<p><strong>Integral Form of PDEs</strong> FVM operates on the integral form of the governing PDEs, as opposed to the differential form used in methods like the Finite Difference Method (FDM). The equations are integrated over each control volume.</p>
<p><strong>Flux Calculations</strong> The key aspect of FVM is the calculation of fluxes of the conserved quantities like mass, momentum, energy across the faces of each control volume. These fluxes are used to determine how these quantities change within each control volume over time.</p>
<p><strong>Boundary Conditions</strong> The method also incorporates boundary conditions, which define how the field behaves at the boundaries of the computational domain.</p>
<p>The general workflow in FVM is the following: Represent the variables like velocity, pressure, temperature at discrete locations in each control volume - either at the cell centers or at the cell faces. The integral form of the governing PDEs is discretized for each control volume. This involves expressing the rate of change of a quantity in a control volume in terms of the fluxes through its faces. The fluxes through the control volume faces are approximated using values of the variables at the centers or faces of the cells. Various schemes like upwind and central difference can be used for this approximation. The discretized equations form a system of algebraic equations. These equations are solved iteratively to find the field values (like pressure, velocity, etc.) throughout the domain. For steady-state problems, iterations continue until the solution converges. For transient problems, the solution is marched forward in time, updating the variables at each time step. One key advantage of the FVM is that it ensures conservation of physical quantities locally (in each control volume) and globally (across the entire domain); it can further handle complex geometries and irregular meshes. In summary, FVM is a versatile and powerful tool for solving complex physical problems numerically.</p>
<p>Openfoam uses what is called a cell-centered finite volume method. This means that the variables are stored at the center of the cells. The fluxes are calculated at the cell faces. The fluxes are then used to update the variables at the cell centers.</p>
</section>
<section id="example-problem-heat-diffusion">
<h2>Example problem: heat diffusion<a class="headerlink" href="#example-problem-heat-diffusion" title="Link to this heading"></a></h2>
<p>Let’s look at an example problem that solves for temperature diffusion, using the laplacianFoam solver.</p>
</section>
<section id="geometry-and-governing-equations">
<h2>Geometry and governing equations<a class="headerlink" href="#geometry-and-governing-equations" title="Link to this heading"></a></h2>
<p>The governing equation is the heat diffusion equation, which is given by:</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-laplacian-con">
<span class="eqno">(48)<a class="headerlink" href="#equation-eq-fvm-laplacian-con" title="Link to this equation"></a></span>\[\rho c_p\frac{\partial T}{\partial t} - \nabla \cdot k \nabla T = 0\]</div>
<div class="math notranslate nohighlight" id="equation-eq-fvm-laplacian-dif">
<span class="eqno">(49)<a class="headerlink" href="#equation-eq-fvm-laplacian-dif" title="Link to this equation"></a></span>\[\frac{\partial T}{\partial t} - \nabla \cdot D \nabla T =0\]</div>
<p><span class="math notranslate nohighlight">\(k\)</span> is the thermal conductivity and <span class="math notranslate nohighlight">\(D\)</span> is the thermal diffusivity <span class="math notranslate nohighlight">\(\frac{k}{\rho c_p}\)</span> . We here assume that <span class="math notranslate nohighlight">\(D\)</span> is a constant value. See also <a class="reference internal" href="../L01/FirstCase.html#theory-heat-diffusion"><span class="std std-ref">Theory</span></a>.</p>
<p>Below is a simple 2D setup for a heat diffusion test case. We will use it to learn about the details of how openFOAM’s FV method works.</p>
<figure class="align-center" id="fvm-geometry-bcs-regularbox" style="width: 100%">
<img alt="../../_images/boundaryConditions_FVM_regularBox.svg" src="../../_images/boundaryConditions_FVM_regularBox.svg" /><figcaption>
<p><span class="caption-number">Fig. 39 </span><span class="caption-text">Model geometry, boundary conditions and initial condition.</span><a class="headerlink" href="#fvm-geometry-bcs-regularbox" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition-what-we-need-to-solve admonition">
<p class="admonition-title">What we need to solve ?</p>
<p>Temperature field <span class="math notranslate nohighlight">\(T\)</span> of the model region at time <span class="math notranslate nohighlight">\(t\)</span>,
therefore <span class="math notranslate nohighlight">\(T\)</span> is the only unknown variable of our problem. It is a scalar field at the center of each cell.</p>
</div>
</section>
<section id="domain-discretization">
<h2>Domain discretization<a class="headerlink" href="#domain-discretization" title="Link to this heading"></a></h2>
<section id="mesh-structure-and-topology">
<h3>Mesh structure and topology<a class="headerlink" href="#mesh-structure-and-topology" title="Link to this heading"></a></h3>
<p>We can use a simple blockMesh to discretize our domain. You can download a prepared case here: <a class="reference download internal" download="" href="../../_downloads/182fc0c7918b295146e8ff66ee704105/regularBox.zip"><code class="xref download docutils literal notranslate"><span class="pre">Regular</span> <span class="pre">box</span> <span class="pre">case</span></code></a>.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">Regular mesh</label><div class="tab-content docutils container">
<figure class="align-center" id="fig-polymesh-regularbox" style="width: 100%">
<img alt="../../_images/mesh_FVM_regularBox.svg" src="../../_images/mesh_FVM_regularBox.svg" /><figcaption>
<p><span class="caption-number">Fig. 40 </span><span class="caption-text">2D regular mesh structure and topology information of OpenFOAM polyMesh (See <a class="reference internal" href="cases/jupyter/VisualizeResults.html#1.-Read-and-plot-mesh-information"><span class="std std-ref">1. Read and plot mesh information</span></a> in the notebook).</span><a class="headerlink" href="#fig-polymesh-regularbox" title="Link to this image"></a></p>
</figcaption>
</figure>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">Unstructured mesh</label><div class="tab-content docutils container">
<figure class="align-center" id="fig-polymesh-unstructured" style="width: 100%">
<img alt="../../_images/mesh_FVM_unstructured.svg" src="../../_images/mesh_FVM_unstructured.svg" /><figcaption>
<p><span class="caption-number">Fig. 41 </span><span class="caption-text">2D unstructured mesh topology information (<a class="reference download internal" download="" href="../../_downloads/511a4a1fe2a54b529f96db7ce8318cd3/unstructured.zip"><code class="xref download docutils literal notranslate"><span class="pre">Regular</span> <span class="pre">box</span> <span class="pre">case</span></code></a>).</span><a class="headerlink" href="#fig-polymesh-unstructured" title="Link to this image"></a></p>
</figcaption>
</figure>
</div>
</div>
<p>The mesh comprises cell centers, cell faces, and cell vertices. The cell centers are the points where the temperature field is stored. The cell faces are the boundaries of the cells. The cell vertices are the points that define the cell faces. Notice how the internal faces (the ones that are not boundary conditions) are numbered continuously starting from 0.</p>
<p>In addition, a connectivity is needed to describe the topology of the mesh. This connectivity describes which cells are connected to each other through the faces. In openFoam a highly efficent data structure is used to store the connectivity information. For each face, the <strong>owner</strong> cell and the <strong>neighbour</strong> cell are stored. The normal vector of face always points from the owner cell to the neighbour cell. The numbering of the vertices that make up the face is again done using the right-hand rule and the face normal always points from the cell with the lower index to the cell with the larger index. Boundary faces  have only an <strong>owner</strong> cell.</p>
<p>You can find details on the mesh description in the <a class="reference external" href="https://cfd.direct/openfoam/user-guide/v8-mesh-description/">OpenFoam manual</a>. Have a look at it and check the structure of the files in <code class="code docutils literal notranslate"><span class="pre">constant/polymesh</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Check your understanding of the openFoam mesh structure and topology by creating the blockMesh mesh for the case we have downloaded and visualizing it using paraview. To create the labels, use the GenerateIds filter in paraview.</p>
</div>
</section>
</section>
<section id="spatial-discretization-the-diffusion-term">
<h2>Spatial discretization: The diffusion term<a class="headerlink" href="#spatial-discretization-the-diffusion-term" title="Link to this heading"></a></h2>
<p>The equation discretization step is performed over each element of the computational domain to yield an algebraic relation that connects the value of a variable in an element to the values of the variable in the neighboring elements <span id="id1">[<a class="reference internal" href="../../refs.html#id2" title="Fadl Moukalled, L Mangani, Marwan Darwish, and others. The finite volume method in computational fluid dynamics. Volume 6. Springer, 2016.">Moukalled et al., 2016</a>]</span>.</p>
<div class="admonition-goal admonition">
<p class="admonition-title">Goal</p>
<p>Transform partial differential <a class="reference internal" href="#equation-eq-fvm-laplacian-dif">equation (49)</a> into a set of algebraic equations: <span class="math notranslate nohighlight">\(\mathbf{A} T = \mathbf{b}\)</span>.</p>
</div>
<ol class="arabic simple">
<li><p>Integrate <a class="reference internal" href="#equation-eq-fvm-laplacian-dif">equation (49)</a> over element <span class="math notranslate nohighlight">\(C\)</span> (the green cell in <a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>) that enables recovering its integral balance form as,</p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-eq-fvm-volume-int">
<span class="eqno">(50)<a class="headerlink" href="#equation-eq-fvm-volume-int" title="Link to this equation"></a></span>\[\iiint\limits_{V_C} \frac{\partial T}{\partial t} dV - \iiint\limits_{V_C} \nabla \cdot D\nabla T dV = 0\]</div>
<p><strong>Note</strong> that the transient term <span class="math notranslate nohighlight">\(\iiint\limits_{V_C} \frac{\partial T}{\partial t} dV\)</span> will be processed in the later section. Let’s set it to zero for the moment and assume steady-state.</p>
<ol class="arabic simple" start="2">
<li><p>Transform the volume integral of the heat flux into a surface integral by applying the divergence theorem,</p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-int">
<span class="eqno">(51)<a class="headerlink" href="#equation-eq-fvm-surface-int" title="Link to this equation"></a></span>\[- \iiint\limits_{V_C} \nabla \cdot D\nabla T dV = -\oint\limits_{\partial V_C} (D\nabla T)\cdot d\vec{S} = 0\]</div>
<p>The <a class="reference internal" href="#equation-eq-fvm-surface-int">equation (51)</a> is actually a heat balance over cell <span class="math notranslate nohighlight">\(C\)</span>.
It is basically the integral form of the original partial differential equation and involves <strong>no approximation</strong>.</p>
<p>The integrant is the <strong>diffusive heat flux</strong>,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-flux-d">
<span class="eqno">(52)<a class="headerlink" href="#equation-eq-fvm-flux-d" title="Link to this equation"></a></span>\[\vec{J}^{T,D} \equiv -D\nabla T\]</div>
<ol class="arabic simple" start="3">
<li><p>Transform the surface integral in <a class="reference internal" href="#equation-eq-fvm-surface-int">equation (51)</a> as a summation over the control volume faces (<strong>still no approximation</strong>),</p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-sum">
<span class="eqno">(53)<a class="headerlink" href="#equation-eq-fvm-surface-sum" title="Link to this equation"></a></span>\[\sum\limits_{f\sim faces(V_C)} \iint\limits_{f}\vec{J}^{T,D}_f \cdot d\vec{S}_f =0\]</div>
<p>Here <span class="math notranslate nohighlight">\(f\)</span> denotes the boundary face of cell <span class="math notranslate nohighlight">\(V_C\)</span>.</p>
<p>Now, the key problem is how to calculate flux integral on a face.</p>
<ol class="arabic simple" start="4">
<li><p>Evaluating flux integral on the faces</p></li>
</ol>
<p>It’s worth noting that there are only two kinds of cells in the discretized domain, one is <strong>internal cell</strong>, the other is <strong>boundary cell</strong>.
All faces of a internal cell are internal faces. The remain cells are boundary cells which contain at least one boundary face.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">Internal cell</label><div class="tab-content docutils container">
<p>For a specific internal cell <span class="math notranslate nohighlight">\(C\)</span>, e.g. cell 12, shown in <a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>,
the <a class="reference internal" href="#equation-eq-fvm-surface-sum">equation (53)</a> can be expanded as,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-sum-expand">
<span class="eqno">(54)<a class="headerlink" href="#equation-eq-fvm-surface-sum-expand" title="Link to this equation"></a></span>\[\color{red}{\iint_{f_{23}}\vec{J}^{T,D}_{f_{23}} \cdot \vec{S}_{f_{23}}} + \iint_{f_{24}}\vec{J}^{T,D}_{f_{24}} \cdot \vec{S}_{f_{24}} + \iint_{f_{21}}\vec{J}^{T,D}_{f_{21}} \cdot \vec{S}_{f_{21}}  + \iint_{f_{5}}\vec{J}^{T,D}_{f_{5}} \cdot \vec{S}_{f_{5}} = 0\]</div>
<p>Note that the surface normals <span class="math notranslate nohighlight">\(\vec{S}\)</span> always point out of the cell; for example, <span class="math notranslate nohighlight">\(\vec{S}_{f_{23}}\)</span> would have a positive and <span class="math notranslate nohighlight">\(\vec{S}_{f_{21}}\)</span> a negative sign.</p>
<p>4.1 Considering face <span class="math notranslate nohighlight">\(f_{23}\)</span>, calculate the first term on the right hand side of the <a class="reference internal" href="#equation-eq-fvm-surface-sum-expand">equation (54)</a> (we have to introduce the <strong>first approximation</strong> at this step). Using a Gaussian quadrature the integral at the face <span class="math notranslate nohighlight">\(f_{23}\)</span>, for example, becomes,</p>
<div class="math notranslate nohighlight" id="equation-fvm-flux-gaussian-integral">
<span class="eqno">(55)<a class="headerlink" href="#equation-fvm-flux-gaussian-integral" title="Link to this equation"></a></span>\[\color{red}{\iint_{f_{23}}\vec{J}^{T,D}_{f_{23}} \cdot \vec{S}_{f_{23}}} = \iint_{f_{23}} (\vec{J}^{T,D}_{f_{23}} \cdot \vec{n}_{f_{23}}) dS_{f_{23}} \approx \color{orange}{\sum\limits_{ip\sim ip(f_{23})} (\vec{J}^{T,D} \cdot \vec{n}_{ip})\omega_{ip} S_{f_{23}}}\]</div>
<p>where <span class="math notranslate nohighlight">\(S_f\)</span> is the area of face <span class="math notranslate nohighlight">\(f_{23}\)</span>, <span class="math notranslate nohighlight">\(ip\)</span> refers to a integration point and <span class="math notranslate nohighlight">\(ip(f_{23})\)</span> the number of integration points along surface <span class="math notranslate nohighlight">\(f_{23}\)</span>, <span class="math notranslate nohighlight">\(\omega_{ip}\)</span> is the integral weights.</p>
<figure class="align-center" id="fig-fig5-2">
<a class="reference internal image-reference" href="../../_images/Fig5.2_RedBook.svg"><img alt="../../_images/Fig5.2_RedBook.svg" src="../../_images/Fig5.2_RedBook.svg" width="100%" /></a>
<figcaption>
<p><span class="caption-number">Fig. 42 </span><span class="caption-text">Surface integration of fluxes using (a) one integration point, (b) two integration points, and (c) three integration points <span id="id2">[<a class="reference internal" href="../../refs.html#id2" title="Fadl Moukalled, L Mangani, Marwan Darwish, and others. The finite volume method in computational fluid dynamics. Volume 6. Springer, 2016.">Moukalled et al., 2016</a>]</span>. The total flux <span class="math notranslate nohighlight">\(FluxT_f\)</span> is computed as linear combinations of the two cell values plus a source term.</span><a class="headerlink" href="#fig-fig5-2" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Only the <strong>one integration point scheme</strong>, i.e. <a class="reference internal" href="#fig-fig5-2"><span class="std std-numref">Fig. 42</span></a> (a), is implemented in OpenFOAM (at least before version 8).
Therefore the first keyword of Laplacian scheme in <code class="code docutils literal notranslate"><span class="pre">system/fvScheme</span></code> dictionary file of a case has only one option, it is <code class="code docutils literal notranslate"><span class="pre">Gauss</span></code>.</p>
</div>
<p>4.2 Choose integral scheme or integral points</p>
<p>To simply explain the calculation process/logic and to also be consistent with OpenFOAM, we here adopt an <strong>one integration point</strong> scheme with weight <span class="math notranslate nohighlight">\(\omega = 1\)</span>, thus <a class="reference internal" href="#equation-fvm-flux-gaussian-integral">equation (55)</a> becomes,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-term-f1">
<span class="eqno">(56)<a class="headerlink" href="#equation-eq-fvm-surface-term-f1" title="Link to this equation"></a></span>\[\color{orange}{\sum\limits_{ip\sim ip(f_{23})} (\vec{J}^{T,D} \cdot \vec{n}_{ip})\omega S_f } = -\left(D \frac{\partial T}{\partial x} \vec{i} + D\frac{\partial T}{\partial y} \vec{j} \right)_{f_{23}} \cdot \Delta y_{f_{23}} \vec{i} = -\color{blue}{\left( D\frac{\partial T}{\partial x} \right)_{f_{23}} \Delta y_{f_{23}}}\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(S_{f_{23}} = \Delta y_{f_{23}}\)</span>  is the area of face  <span class="math notranslate nohighlight">\(f_{23}\)</span> by assuming <span class="math notranslate nohighlight">\(\Delta z = 1\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\vec{S}_{f_{23}} = S_{f_{23}} \vec{n}_{f_{23}}\)</span> is the surface vector of face <span class="math notranslate nohighlight">\(f_{23}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\vec{n}_{f_{23}} = \vec{i}\)</span> is the normal vector of the face <span class="math notranslate nohighlight">\(f_{23}\)</span> directed out of the cell <span class="math notranslate nohighlight">\(C\)</span> (see <a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>).</p></li>
</ul>
<p>4.3 Calculate gradient of <span class="math notranslate nohighlight">\(T\)</span> at face centroid, here introduce <strong>the second approximation</strong>, e.g. assuming linear variation of T and then the gradient term in the <a class="reference internal" href="#equation-eq-fvm-surface-term-f1">equation (56)</a> can be approximated as,</p>
<div class="math notranslate nohighlight">
\[-\color{blue}{\left( D\frac{\partial T}{\partial x} \right)_{f_{23}} \Delta y_{f_{23}}} = -D\frac{T_{13} - T_{C}}{x_{13} - x_C}\Delta y_{f_{23}} = -\frac{D \Delta y_{f_{23}}}   {\delta x_{f_{23}}}   (T_{13} - T_{C})\]</div>
<p>where <span class="math notranslate nohighlight">\(\delta x_{f_{23}}\)</span> represents the distance between center of cells who share face <span class="math notranslate nohighlight">\(f_{23}\)</span>, they are cell 12 and cell 13.</p>
<p>Now let’s look at the western face <span class="math notranslate nohighlight">\(f_{21}\)</span> . Using a single integration point, we can again write:</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-term-f1-west">
<span class="eqno">(57)<a class="headerlink" href="#equation-eq-fvm-surface-term-f1-west" title="Link to this equation"></a></span>\[\color{orange}{\sum\limits_{ip\sim ip(f_{21})} (\vec{J}^{T,D} \cdot \vec{n}_{ip})\omega S_f } = -\left(D \frac{\partial T}{\partial x} \vec{i} + D\frac{\partial T}{\partial y} \vec{j} \right)_{f_{21}} \cdot \Delta y_{f_{21}} \cdot-\vec{i} = \color{blue}{\left( D\frac{\partial T}{\partial x} \right)_{f_{21}} \Delta y_{f_{21}}}\]</div>
<p>Notice how the surface normal now has the opposite sign!</p>
<p>We continue to spell out the flux across face <span class="math notranslate nohighlight">\(f_{21}\)</span> as:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\color{blue}{\left( D\frac{\partial T}{\partial x} \right)_{f_{21}} \Delta y_{f_{21}}} = D\frac{T_{C} - T_{11}}{x_{11} - x_C}\Delta y_{f_{21}} = -\frac{D \Delta y_{f_{21}}}   {\delta x_{f_{21}}}   (T_{11} - T_{C})\]</div>
</div></blockquote>
<p>Do the same thing for the remain faces (<span class="math notranslate nohighlight">\(f_5, f_{24}\)</span>).</p>
<p>4.3 Construct coefficients of a specific cell <span class="math notranslate nohighlight">\(C_{12}\)</span></p>
<p>Now we get all the coefficients, thus the <a class="reference internal" href="#equation-eq-fvm-surface-sum-expand">equation (54)</a> can be discretized and expressed as a matrix form,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-matrix-form-internalcell">
<span class="eqno">(58)<a class="headerlink" href="#equation-eq-fvm-matrix-form-internalcell" title="Link to this equation"></a></span>\[a_{C} T_C + a_{F_{23}} T_{F_{23}} + a_{F_{24}} T_{F_{24}} + a_{F_{21}} T_{F_{21}} + a_{F_{5}} T_{F_{5}} = 0\]</div>
<p>with</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{eqnarray}
a_{23} &amp; = &amp;  -\frac{D \Delta y_{f_{23}}}   {\delta x_{f_{23}}} \\
a_{24} &amp; = &amp;  -\frac{D \Delta y_{f_{24}}}   {\delta x_{f_{24}}} \\
a_{21} &amp; = &amp;  -\frac{D \Delta y_{f_{21}}}   {\delta x_{f_{21}}} \\
a_{5} &amp; = &amp;  -\frac{D \Delta y_{f_{5}}}   {\delta x_{f_{5}}} \\
a_{C} &amp; = &amp; -(a_{23} + a_{24} + a_{21}  + a_{5}) \\
\end{eqnarray}\end{split}\]</div>
<div class="math notranslate nohighlight" id="equation-eq-fvm-matrix-form-internalcell12">
<span class="eqno">(59)<a class="headerlink" href="#equation-eq-fvm-matrix-form-internalcell12" title="Link to this equation"></a></span>\[\mathbf{A}_{N\times N}[12,:] \mathbf{T}_{N\times 1} =  0\]</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">Boundary cell</label><div class="tab-content docutils container">
<p>For a specific boundary cell, e.g. <strong>cell 19</strong> shown in <a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>, the <a class="reference internal" href="#equation-eq-fvm-surface-sum">equation (53)</a> can be rewritten as,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-sum-expand-boundary">
<span class="eqno">(60)<a class="headerlink" href="#equation-eq-fvm-surface-sum-expand-boundary" title="Link to this equation"></a></span>\[\iint_{f_{18}}\vec{J}^{T,D}_{f_{18}} \cdot \vec{S}_{f_{18}} + \iint_{f_{35}}\vec{J}^{T,D}_{f_{35}} \cdot \vec{S}_{f_{35}} +\iint_{f_{37}}\vec{J}^{T,D}_{f_{37}} \cdot \vec{S}_{f_{37}} + \color{red}{\iint_{f_{51}}\vec{J}^{T,D}_{f_{51}} \cdot \vec{S}_{f_{51}}} = 0\]</div>
<p>The first three terms are normal fluxes across internal faces, so there is nothing special and we can just calculate them following steps for internal faces as before. The special thing is the boundary face <span class="math notranslate nohighlight">\(f_{52}\)</span>, we can call it <span class="math notranslate nohighlight">\(f_b\)</span> for a general case. <strong>Now the problem is how to evaluate flux on the boundary face</strong> <span class="math notranslate nohighlight">\(f_b\)</span>.</p>
<p>The fluxes on the interior faces are discretized as before, while <strong>the boundary flux is discretized with the aim of constructing a linearization with respect to</strong> the cell field <span class="math notranslate nohighlight">\(T_C\)</span>, e.g. <span class="math notranslate nohighlight">\(T_{C_{19}}\)</span> of cell <span class="math notranslate nohighlight">\(C_{19}\)</span> shown in <a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>, thus</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-surface-flux-boundary">
<span class="eqno">(61)<a class="headerlink" href="#equation-eq-fvm-surface-flux-boundary" title="Link to this equation"></a></span>\[\color{red}{\iint_{f_{b}}\vec{J}^{T,D}_{f_{b}} \cdot d\vec{S}_{f_{b}}} = a_{F_b} T_C + c_{F_b}\]</div>
<p>All right, <strong>now out goal is to determine the coefficients of</strong> <span class="math notranslate nohighlight">\(a_{F_b}\)</span> and <span class="math notranslate nohighlight">\(c_{F_b}\)</span> according to the boundary conditions. Generally there are two basic kinds of boundary conditions, they are <strong>Dirichlet boundary condition</strong> (also called the first type or fixed value boundary condition) and <strong>Von Neumann boundary condition</strong> (all called the second type or fixed flux boundary condition), respectively.</p>
<p>4.1 Fixed value boundary condition</p>
<p>Fixed value means the value of field <span class="math notranslate nohighlight">\(T\)</span> is given on the boundary face is give, i.e. <span class="math notranslate nohighlight">\(\color{purple}{T_{f_b}}\)</span> is given. There fore we can calculate flux on boundary face, <span class="math notranslate nohighlight">\(f_{51}\)</span> for example,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-flux-boundary">
<span class="eqno">(62)<a class="headerlink" href="#equation-eq-fvm-flux-boundary" title="Link to this equation"></a></span>\[\color{red}{\iint_{f_{51}}\vec{J}^{T,D}_{f_{51}} \cdot \vec{S}_{f_{51}}} = \iint_{f_{51}} (\vec{J}^{T,D}_{f_{51}} \cdot \vec{n}_{f_{51}}) dS_{f_{51}} \approx \color{orange}{\sum\limits_{ip\sim ip(f_{51})} (\vec{J}^{T,D} \cdot \vec{n}_{ip})\omega_{ip} S_{f_{51}}}\]</div>
<p>Here we still use one integration point scheme to explain the calculation process,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-flux-gaussian-integral-boundary">
<span class="eqno">(63)<a class="headerlink" href="#equation-eq-fvm-flux-gaussian-integral-boundary" title="Link to this equation"></a></span>\[\color{orange}{\sum\limits_{ip\sim ip(f_{51})} (\vec{J}^{T,D} \cdot \vec{n}_{ip})\omega S_f } = -\left(D \frac{\partial T}{\partial x} \vec{i} + D\frac{\partial T}{\partial y} \vec{j} \right)_{f_{51}} \cdot \Delta y_{f_{51}} \vec{i} = -\color{blue}{\left( D\frac{\partial T}{\partial x} \right)_{f_{51}} \Delta y_{f_{51}}}\]</div>
<p>Now let’s calculate the gradient on the boundary face,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-gradient-boundary">
<span class="eqno">(64)<a class="headerlink" href="#equation-eq-fvm-gradient-boundary" title="Link to this equation"></a></span>\[-\color{blue}{\left( D\frac{\partial T}{\partial x} \right)_{f_{51}} \Delta y_{f_{51}}} = -D\frac{\color{purple}{T_{f_{51}}} - T_{C}}{x_{f_{51}} - x_C}\Delta y_{f_{51}} = -\frac{D \Delta y_{f_{51}}}{\delta x_{f_{51}}}(\color{purple}{T_{f_{51}}} - T_{C}) = a_{f_{51}}(-T_{C}) +  c_{f_{51}}\]</div>
<p>Substituting <a class="reference internal" href="#equation-eq-fvm-gradient-boundary">equation (64)</a> back to  <a class="reference internal" href="#equation-eq-fvm-flux-gaussian-integral-boundary">equation (63)</a>, <a class="reference internal" href="#equation-eq-fvm-flux-boundary">equation (62)</a> and  <a class="reference internal" href="#equation-eq-fvm-surface-flux-boundary">equation (61)</a>, we can get Laplacian discretization coefficients <span class="math notranslate nohighlight">\(a_{f_{51}}\)</span> and <span class="math notranslate nohighlight">\(c_{f_{51}}\)</span>,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-laplacian-coeff-boundary-fixedvalue">
<span class="eqno">(65)<a class="headerlink" href="#equation-eq-fvm-laplacian-coeff-boundary-fixedvalue" title="Link to this equation"></a></span>\[\begin{split}\begin{eqnarray}
a_{F_{51}} &amp;=&amp; -D\frac{\Delta y_{f_{51}}}{\delta x_{f_{51}}}\\
c_{F_{51}} &amp;=&amp; a_{F_{51}}\color{purple}{T_{f_{51}}}
\end{eqnarray}\end{split}\]</div>
<p>Notice how <span class="math notranslate nohighlight">\(\color{purple}{T_{f_{51}}}\)</span> is known (a boundary condition), so that the term <span class="math notranslate nohighlight">\(-a_{F_{51}}\color{purple}{T_{f_{51}}}\)</span> will end up on the right-hand side and not in the coefficient matrix.</p>
<p>4.2 Fixed flux boundary condition</p>
<p><strong>Fixed flux</strong> means <strong>normal gradient to the boundary face</strong> of field <span class="math notranslate nohighlight">\(T\)</span> is given, i.e. <span class="math notranslate nohighlight">\(\color{purple}{\vec{J}^{T,D}_{f_{b}} \cdot \vec{n}_{f_{b}} = q_{f_b}}\)</span> is given. There fore we can calculate flux on boundary face, <span class="math notranslate nohighlight">\(f_{51}\)</span> for example,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-fixedflux-boundary">
<span class="eqno">(66)<a class="headerlink" href="#equation-eq-fvm-fixedflux-boundary" title="Link to this equation"></a></span>\[\color{red}{\iint_{f_{51}}\vec{J}^{T,D}_{f_{51}} \cdot \vec{S}_{f_{51}}} = \iint_{f_{51}} (\vec{J}^{T,D}_{f_{51}} \cdot \vec{n}_{f_{51}}) dS_{f_{51}} = \iint_{f_{51}} \color{purple}{q_{f_{51}}} dS_{f_{51}} = \color{purple}{q_{f_{51}}} S_{f_{51}} = \color{purple}{q_{f_{51}}} \Delta y_{f_{51}}\]</div>
<p>Substituting <a class="reference internal" href="#equation-eq-fvm-fixedflux-boundary">equation (66)</a> back to <a class="reference internal" href="#equation-eq-fvm-surface-flux-boundary">equation (61)</a>, we can get Laplacian discretization coefficients <span class="math notranslate nohighlight">\(a_{f_{51}}\)</span> and <span class="math notranslate nohighlight">\(c_{f_{51}}\)</span>,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-laplacian-coeff-boundary-fixedflux">
<span class="eqno">(67)<a class="headerlink" href="#equation-eq-fvm-laplacian-coeff-boundary-fixedflux" title="Link to this equation"></a></span>\[\begin{split}\begin{eqnarray}
a_{F_{51}} &amp;=&amp; 0 \\
c_{F_{51}} &amp;=&amp; \color{purple}{q_{f_{51}}} \Delta y_{f_{51}}
\end{eqnarray}\end{split}\]</div>
<p>4.3 Construct coefficients of the boundary cell <span class="math notranslate nohighlight">\(C_{19}\)</span></p>
<p>Do the same thing as 4.1 or 4.2 (depends on the type of boundary condition) for all boundary faces of a boundary cell <span class="math notranslate nohighlight">\(C\)</span> and calculate the coefficients of <span class="math notranslate nohighlight">\(a_{F_b}\)</span> and <span class="math notranslate nohighlight">\(c_{F_b}\)</span>, then the <a class="reference internal" href="#equation-eq-fvm-surface-sum-expand-boundary">equation (60)</a> can be expressed as,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-matrix-form-boundarycell">
<span class="eqno">(68)<a class="headerlink" href="#equation-eq-fvm-matrix-form-boundarycell" title="Link to this equation"></a></span>\[\begin{split}  \begin{eqnarray}
b_{C_{19}} &amp; =  &amp; a_{F_{18}} (T_{F_{18}} - T_C) + a_{F_{35}} (T_{F_{35}} - T_C) + a_{F_{37}} (T_{F_{37}} - T_C) + a_{F_{51}} (-T_C) +c_{F_{51}} \\
   &amp; = &amp; \sum\limits_{f\in[18, 35, 37]} a_{F_f} T_{F_f} + \left(-\sum\limits_{f\in[18, 35, 37, 51]} a_{F_f} \right) T_C + \sum\limits_{f\in[51]} c_{F_f} \\
   &amp; = &amp; \sum\limits_{f\sim nb(\text{internal face})} a_{F_f} T_{F_f} + \left(-\sum\limits_{f\sim nb(\text{all face})} a_{F_f} \right) T_C + \sum\limits_{f\sim nb(\text{boundary face})} c_{F_f}
\end{eqnarray}\end{split}\]</div>
<div class="math notranslate nohighlight" id="equation-eq-fvm-matrix-form-boundarycell19">
<span class="eqno">(69)<a class="headerlink" href="#equation-eq-fvm-matrix-form-boundarycell19" title="Link to this equation"></a></span>\[\mathbf{A}_{N\times N}[19,:] \mathbf{T}_{N\times 1} =  B_{19}\]</div>
<p>where <span class="math notranslate nohighlight">\(B_{19} = b_{C_{19}} - \sum\limits_{f\sim nb(\text{boundary face})} c_{F_f}\)</span>.</p>
</div>
</div>
<ol class="arabic simple" start="5">
<li><p>Construct general matrix form of the <a class="reference internal" href="#equation-eq-fvm-surface-sum">equation (53)</a></p></li>
</ol>
<div class="math notranslate nohighlight" id="equation-eq-fvm-matrix-form0">
<span class="eqno">(70)<a class="headerlink" href="#equation-eq-fvm-matrix-form0" title="Link to this equation"></a></span>\[\begin{split}\begin{eqnarray}
-\sum\limits_{f\sim nb(C)} (D\nabla T)_{F_f}\cdot \vec{S}_{F_f} &amp; = &amp;  \sum\limits_{f\sim \text{internal faces}(C)} a_{F_f} T_{C} + \left(-\sum\limits_{f\sim nb(C)} a_{F_f} T_{F_f} \right) + \sum\limits_{f\sim \text{boundary faces}(C)} c_{F_{F_f}} \\
&amp; = &amp; a_CT_C - \sum\limits_{f\sim \text{internal faces}(C)} a_{F_f} T_{F_f} + \sum\limits_{f\sim \text{boundary faces}(C)} c_{F_{f}}
\end{eqnarray}\end{split}\]</div>
<p>Matrix form of the <a class="reference internal" href="#equation-eq-fvm-surface-sum">equation (53)</a> can be written as,</p>
<div class="math notranslate nohighlight" id="equation-fvm-matrix-form">
<span class="eqno">(71)<a class="headerlink" href="#equation-fvm-matrix-form" title="Link to this equation"></a></span>\[\mathbf{A}_{N \times N} \mathbf{T}_{N\times1} = \mathbf{B}_{N\times1}\]</div>
<p>here <span class="math notranslate nohighlight">\(N\)</span> is the number of cell, <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> is a sparse matrix of coefficients,
<span class="math notranslate nohighlight">\(\mathbf{T}\)</span> is cell-centered temperature field.
The matrix is visualized as <a class="reference internal" href="#fig-fvm-matrix"><span class="std std-numref">Fig. 43</span></a>.
It should be noted that <strong>the coefficients matrix of Laplacian term is a symmetric matrix and the boundary conditions only affect diagonal entry of the coefficients matrix</strong>. Further, only the fixed value boundary condition affects the matrix and the fixed flux boundary condition affects the RHS(Right hand of side) <span class="math notranslate nohighlight">\(B\)</span>.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">Regular mesh</label><div class="tab-content docutils container">
<figure class="align-center" id="fig-fvm-matrix" style="width: 100%">
<img alt="../../_images/matrix_FVM_regularBox.svg" src="../../_images/matrix_FVM_regularBox.svg" /><figcaption>
<p><span class="caption-number">Fig. 43 </span><span class="caption-text">Visualization of <span class="math notranslate nohighlight">\(\mathbf{A}_{N \times N} \mathbf{T}_{N\times1} = \mathbf{b}_{N\times1}\)</span>.
The coefficients of the selected cell <span class="math notranslate nohighlight">\(C\)</span> (<a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>) are marked by green rectangle.</span><a class="headerlink" href="#fig-fvm-matrix" title="Link to this image"></a></p>
</figcaption>
</figure>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">Unstructured mesh</label><div class="tab-content docutils container">
<figure class="align-center" id="fig-fvm-matrix-unstructured" style="width: 100%">
<img alt="../../_images/matrix_FVM_unstructured.svg" src="../../_images/matrix_FVM_unstructured.svg" /><figcaption>
<p><span class="caption-number">Fig. 44 </span><span class="caption-text">Visualization of <span class="math notranslate nohighlight">\(\mathbf{A}_{N \times N} \mathbf{T}_{N\times1} = \mathbf{b}_{N\times1}\)</span>.
The coefficients of the selected cell <span class="math notranslate nohighlight">\(C\)</span> (<a class="reference internal" href="#fig-polymesh-regularbox"><span class="std std-numref">Fig. 40</span></a>) are marked by green rectangle.</span><a class="headerlink" href="#fig-fvm-matrix-unstructured" title="Link to this image"></a></p>
</figcaption>
</figure>
</div>
</div>
</section>
<section id="temporal-discretization-the-transient-term">
<h2>Temporal Discretization: The Transient Term<a class="headerlink" href="#temporal-discretization-the-transient-term" title="Link to this heading"></a></h2>
<p>After spatial discretization, the <a class="reference internal" href="#equation-eq-fvm-volume-int">equation (50)</a> can be expressed as,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-diffusioneq-spatial-dis">
<span class="eqno">(72)<a class="headerlink" href="#equation-eq-fvm-diffusioneq-spatial-dis" title="Link to this equation"></a></span>\[\frac{\partial T}{\partial t} V_C - L(T_C^t) =0\]</div>
<p>where <span class="math notranslate nohighlight">\(V_C\)</span> is the volume of the discretization cell and <span class="math notranslate nohighlight">\(L(T_C^t)\)</span> is the spatial discretization operator expressed at some reference time <span class="math notranslate nohighlight">\(t\)</span>, which can be written as algebraic form (see also <a class="reference internal" href="#equation-eq-fvm-matrix-form0">equation (70)</a>),</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-spatial-dis-algebraic">
<span class="eqno">(73)<a class="headerlink" href="#equation-eq-fvm-spatial-dis-algebraic" title="Link to this equation"></a></span>\[L(T_C^t) = a_C T_C^t - \sum\limits_{F\sim NB(C)} a_F T_F^t + \sum\limits_{F\sim NB(C)} c_F\]</div>
<p>where <span class="math notranslate nohighlight">\(a_C\)</span> is the diagonal coefficients of the matrix, <span class="math notranslate nohighlight">\(a_F\)</span> is the off-diagonal coefficients, and the <span class="math notranslate nohighlight">\(c_F\)</span> is the source coefficients as right hand side of matrix of system.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For specific cell <span class="math notranslate nohighlight">\(C\)</span>,
* <span class="math notranslate nohighlight">\(a_F\)</span> has only contributed from internal faces.
* <span class="math notranslate nohighlight">\(a_C\)</span> is the negative summation of <span class="math notranslate nohighlight">\(a_F\)</span>, contributed from all faces, but equation of the <span class="math notranslate nohighlight">\(a_F\)</span> for a boundary faces (<a class="reference internal" href="#equation-eq-fvm-laplacian-coeff-boundary-fixedvalue">equation (65)</a> and <a class="reference internal" href="#equation-eq-fvm-laplacian-coeff-boundary-fixedflux">equation (67)</a>) is a little bit different from internal face.</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(c_F\)</span> only comes from boundary faces of cell <span class="math notranslate nohighlight">\(C\)</span> if it has boundary face, see also <a class="reference internal" href="#equation-eq-fvm-laplacian-coeff-boundary-fixedvalue">equation (65)</a> and <a class="reference internal" href="#equation-eq-fvm-laplacian-coeff-boundary-fixedflux">equation (67)</a>. <span class="math notranslate nohighlight">\(c_F\)</span> will contribute to RHS (<span class="math notranslate nohighlight">\(\mathbf{B}\)</span>) of the algebraic <a class="reference internal" href="#equation-fvm-matrix-form">equation (71)</a>.</p></li>
</ul>
</div>
<p>Let’s do the temporal discretization for the first term of <a class="reference internal" href="#equation-eq-fvm-diffusioneq-spatial-dis">equation (72)</a>,</p>
<div class="math notranslate nohighlight">
\[\frac{T^{t+\Delta t/2} - T^{t - \Delta t/2}}{\Delta t} V_C + L(T_C^t) = 0\]</div>
<p>To derive the full discretized equation, an interpolation profile expressing the face values at (<span class="math notranslate nohighlight">\(t-\Delta t/2\)</span>) and (<span class="math notranslate nohighlight">\(t+\Delta t\)</span>) in terms of the element values at (<span class="math notranslate nohighlight">\(t\)</span>), (<span class="math notranslate nohighlight">\(t-\Delta t\)</span>), etc., is needed.Independent of the profile used, the flux will be linearized based on old and new values as,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-temporal-linear">
<span class="eqno">(74)<a class="headerlink" href="#equation-eq-fvm-temporal-linear" title="Link to this equation"></a></span>\[b_C = FluxC T_C + FluxC^o T_C^o + FluxV\]</div>
<p>where the superscript <span class="math notranslate nohighlight">\(^{o}\)</span> refers to old values. With the format of the linearization,
the coefficient <span class="math notranslate nohighlight">\(FluxC\)</span> will be <strong>added to diagonal element</strong> and the coefficient <span class="math notranslate nohighlight">\(FluxC^o T_C^o + FluxV\)</span> will be <strong>added to the source or RHS</strong> (<span class="math notranslate nohighlight">\(B\)</span>).</p>
<section id="first-order-implicit-euler-scheme">
<h3>First order implicit Euler scheme<a class="headerlink" href="#first-order-implicit-euler-scheme" title="Link to this heading"></a></h3>
<div class="math notranslate nohighlight" id="equation-eq-fvm-firstorder-euler-imp">
<span class="eqno">(75)<a class="headerlink" href="#equation-eq-fvm-firstorder-euler-imp" title="Link to this equation"></a></span>\[\frac{T^t - T^{t-\Delta t}}{\Delta t} V_C - L(T^{t}) = 0\]</div>
<p>Therefore the coefficients will be</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-firstorder-euler-imp-coeff">
<span class="eqno">(76)<a class="headerlink" href="#equation-eq-fvm-firstorder-euler-imp-coeff" title="Link to this equation"></a></span>\[FluxC = \frac{V_C}{\Delta t}, ~ FluxC^o = - \frac{V_C}{\Delta t}, ~ FluxV =0\]</div>
</section>
<section id="first-order-explicit-euler-scheme">
<h3>First order explicit Euler scheme<a class="headerlink" href="#first-order-explicit-euler-scheme" title="Link to this heading"></a></h3>
<div class="math notranslate nohighlight" id="equation-eq-fvm-firstorder-euler-exp">
<span class="eqno">(77)<a class="headerlink" href="#equation-eq-fvm-firstorder-euler-exp" title="Link to this equation"></a></span>\[\frac{T^{t+\Delta t} - T^t}{\Delta t} V_C - L(T^{t}) = 0\]</div>
<p>Note that now the new time is at <span class="math notranslate nohighlight">\(t+\Delta t\)</span> and that the spatial operator (<span class="math notranslate nohighlight">\(L\)</span>) of <a class="reference internal" href="#equation-eq-fvm-firstorder-euler-exp">equation (77)</a> has to be evaluated at time <span class="math notranslate nohighlight">\(t\)</span>.
Therefore, in order to find the value of <span class="math notranslate nohighlight">\(T\)</span> at time <span class="math notranslate nohighlight">\(t+\Delta t\)</span>, we don’t need to solve a set of linear algebraic equations,</p>
<div class="math notranslate nohighlight" id="equation-eq-fvm-firstorder-euler-exp-coef">
<span class="eqno">(78)<a class="headerlink" href="#equation-eq-fvm-firstorder-euler-exp-coef" title="Link to this equation"></a></span>\[T^{t+\Delta t} = \frac{\Delta t}{V_C} L(T^{t}) + T^t\]</div>
</section>
</section>
<section id="building-the-matrix-mesh-connectivity-and-internal-data-storage">
<h2>Building the matrix: Mesh connectivity and internal data storage<a class="headerlink" href="#building-the-matrix-mesh-connectivity-and-internal-data-storage" title="Link to this heading"></a></h2>
<p>Remember the mesh structure discussed above. The mesh connectivity is stored in the <code class="code docutils literal notranslate"><span class="pre">polyMesh</span></code> folder, which containes the <code class="code docutils literal notranslate"><span class="pre">neighbour</span></code> and <code class="code docutils literal notranslate"><span class="pre">owner</span></code> files. The normal vector of the face always points from the owner cell to the neighbour cell. The numbering of the vertices that make up the face is again done using the right-hand rule and the face normal always points from the cell with the lower index to the cell with the larger index. Boundary faces have only an owner cell.</p>
<p>Is is straightforward to find the indices for setting up the flux balance for each cell, as we did in <a class="reference internal" href="#equation-eq-fvm-matrix-form-internalcell">equation (58)</a>?</p>
<p>No, because the owner/neighbor data structure does not provide the indices of all the cells that are connected to a given cell. Rather the owner/neighbor data structure is “face-centered” in that for each face, we know which cells are on each side. Hence, we can easily loop over all faces and compute the fluxes but we cannot easily loop over cells and compute the fluxes to/from the neighboring cells.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Check out how openfoam makes use of this face-centered logic to compute the average gradient of a field in the <code class="code docutils literal notranslate"><span class="pre">gaussGrad</span></code> function in <code class="code docutils literal notranslate"><span class="pre">src/finiteVolume/finiteVolume/gradSchemes/gaussGrad/gaussGrad.C</span></code> (see below). The forAll loop is on the faces and the owner and neighbour functions are used to get the indices of the cells that are connected to a given face.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 26 </span><span class="caption-text">src/finiteVolume/finiteVolume/gradSchemes/gaussGrad/gaussGrad.C</span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-foam notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*---------------------------------------------------------------------------*\</span>
<span class="linenos">  2</span><span class="cm">  =========                 |</span>
<span class="linenos">  3</span><span class="cm">  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox</span>
<span class="linenos">  4</span><span class="cm">   \\    /   O peration     | Website:  https://openfoam.org</span>
<span class="linenos">  5</span><span class="cm">    \\  /    A nd           | Copyright (C) 2011-2018 OpenFOAM Foundation</span>
<span class="linenos">  6</span><span class="cm">     \\/     M anipulation  |</span>
<span class="linenos">  7</span><span class="cm">-------------------------------------------------------------------------------</span>
<span class="linenos">  8</span><span class="cm">License</span>
<span class="linenos">  9</span><span class="cm">This file is part of OpenFOAM.</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="cm">OpenFOAM is free software: you can redistribute it and/or modify it</span>
<span class="linenos"> 12</span><span class="cm">under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 13</span><span class="cm">the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 14</span><span class="cm">(at your option) any later version.</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="cm">OpenFOAM is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="linenos"> 17</span><span class="cm">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="linenos"> 18</span><span class="cm">FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="linenos"> 19</span><span class="cm">for more details.</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="cm">You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 22</span><span class="cm">along with OpenFOAM.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="cm">\*---------------------------------------------------------------------------*/</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="cp">#include</span> <span class="cpf">&quot;gaussGrad.H&quot;</span>
<span class="linenos"> 27</span><span class="cp">#include</span> <span class="cpf">&quot;extrapolatedCalculatedFvPatchField.H&quot;</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="c1">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="n">template</span><span class="o">&lt;</span><span class="kt">class</span> <span class="n">Type</span><span class="o">&gt;</span>
<span class="linenos"> 32</span><span class="n">Foam</span><span class="o">::</span><span class="n">tmp</span>
<span class="linenos"> 33</span><span class="o">&lt;</span>
<span class="linenos"> 34</span>   <span class="n">Foam</span><span class="o">::</span><span class="n">GeometricField</span>
<span class="linenos"> 35</span>   <span class="o">&lt;</span>
<span class="linenos"> 36</span>      <span class="kr">typename</span> <span class="n">Foam</span><span class="o">::</span><span class="n">outerProduct</span><span class="o">&lt;</span><span class="n">Foam</span><span class="o">::</span><span class="n">vector</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;::</span><span class="kt">type</span><span class="p">,</span>
<span class="linenos"> 37</span>      <span class="n">Foam</span><span class="o">::</span><span class="n">fvPatchField</span><span class="p">,</span>
<span class="linenos"> 38</span>      <span class="n">Foam</span><span class="o">::</span><span class="n">volMesh</span>
<span class="linenos"> 39</span>   <span class="o">&gt;</span>
<span class="linenos"> 40</span><span class="o">&gt;</span>
<span class="linenos"> 41</span><span class="n">Foam</span><span class="o">::</span><span class="n">fv</span><span class="o">::</span><span class="n">gaussGrad</span><span class="o">&lt;</span><span class="n">Type</span><span class="o">&gt;::</span><span class="n">gradf</span>
<span class="linenos"> 42</span><span class="p">(</span>
<span class="linenos"> 43</span>   <span class="k">const</span> <span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">fvsPatchField</span><span class="p">,</span> <span class="n">surfaceMesh</span><span class="o">&gt;&amp;</span> <span class="n">ssf</span><span class="p">,</span>
<span class="linenos"> 44</span>   <span class="k">const</span> <span class="n">word</span><span class="o">&amp;</span> <span class="n">name</span>
<span class="linenos"> 45</span><span class="p">)</span>
<span class="linenos"> 46</span><span class="p">{</span>
<span class="linenos"> 47</span>   <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">outerProduct</span><span class="o">&lt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;::</span><span class="kt">type</span> <span class="n">GradType</span><span class="p">;</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span>   <span class="k">const</span> <span class="n">fvMesh</span><span class="o">&amp;</span> <span class="n">mesh</span> <span class="o">=</span> <span class="n">ssf</span><span class="p">.</span><span class="n">mesh</span><span class="p">();</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span>   <span class="n">tmp</span><span class="o">&lt;</span><span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">GradType</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;&gt;</span> <span class="n">tgGrad</span>
<span class="linenos"> 52</span>   <span class="p">(</span>
<span class="linenos"> 53</span>      <span class="n">new</span> <span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">GradType</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;</span>
<span class="linenos"> 54</span>      <span class="p">(</span>
<span class="linenos"> 55</span>            <span class="n">IOobject</span>
<span class="linenos"> 56</span>            <span class="p">(</span>
<span class="linenos"> 57</span>               <span class="n">name</span><span class="p">,</span>
<span class="linenos"> 58</span>               <span class="n">ssf</span><span class="p">.</span><span class="n">instance</span><span class="p">(),</span>
<span class="linenos"> 59</span>               <span class="n">mesh</span><span class="p">,</span>
<span class="linenos"> 60</span>               <span class="n">IOobject</span><span class="o">::</span><span class="n">NO_READ</span><span class="p">,</span>
<span class="linenos"> 61</span>               <span class="n">IOobject</span><span class="o">::</span><span class="n">NO_WRITE</span>
<span class="linenos"> 62</span>            <span class="p">),</span>
<span class="linenos"> 63</span>            <span class="n">mesh</span><span class="p">,</span>
<span class="linenos"> 64</span>            <span class="n">dimensioned</span><span class="o">&lt;</span><span class="n">GradType</span><span class="o">&gt;</span>
<span class="linenos"> 65</span>            <span class="p">(</span>
<span class="linenos"> 66</span>               <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="linenos"> 67</span>               <span class="n">ssf</span><span class="p">.</span><span class="kt">dimensions</span><span class="p">()</span><span class="o">/</span><span class="n">dimLength</span><span class="p">,</span>
<span class="linenos"> 68</span>               <span class="n">Zero</span>
<span class="linenos"> 69</span>            <span class="p">),</span>
<span class="linenos"> 70</span>            <span class="n">extrapolatedCalculatedFvPatchField</span><span class="o">&lt;</span><span class="n">GradType</span><span class="o">&gt;::</span><span class="n">typeName</span>
<span class="linenos"> 71</span>      <span class="p">)</span>
<span class="linenos"> 72</span>   <span class="p">);</span>
<span class="linenos"> 73</span>   <span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">GradType</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;&amp;</span> <span class="n">gGrad</span> <span class="o">=</span> <span class="n">tgGrad</span><span class="p">.</span><span class="n">ref</span><span class="p">();</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span>   <span class="k">const</span> <span class="n">labelUList</span><span class="o">&amp;</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">owner</span><span class="p">();</span>
<span class="linenos"> 76</span>   <span class="k">const</span> <span class="n">labelUList</span><span class="o">&amp;</span> <span class="n">neighbour</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">neighbour</span><span class="p">();</span>
<span class="linenos"> 77</span>   <span class="k">const</span> <span class="n">vectorField</span><span class="o">&amp;</span> <span class="n">Sf</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">Sf</span><span class="p">();</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>   <span class="n">Field</span><span class="o">&lt;</span><span class="n">GradType</span><span class="o">&gt;&amp;</span> <span class="n">igGrad</span> <span class="o">=</span> <span class="n">gGrad</span><span class="p">;</span>
<span class="linenos"> 80</span>   <span class="k">const</span> <span class="n">Field</span><span class="o">&lt;</span><span class="n">Type</span><span class="o">&gt;&amp;</span> <span class="n">issf</span> <span class="o">=</span> <span class="n">ssf</span><span class="p">;</span>
<span class="linenos"> 81</span>
<span class="hll"><span class="linenos"> 82</span>   <span class="n">forAll</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">facei</span><span class="p">)</span>
</span><span class="hll"><span class="linenos"> 83</span>   <span class="p">{</span>
</span><span class="hll"><span class="linenos"> 84</span>      <span class="n">GradType</span> <span class="n">Sfssf</span> <span class="o">=</span> <span class="n">Sf</span><span class="p">[</span><span class="n">facei</span><span class="p">]</span><span class="o">*</span><span class="n">issf</span><span class="p">[</span><span class="n">facei</span><span class="p">];</span>
</span><span class="hll"><span class="linenos"> 85</span>
</span><span class="hll"><span class="linenos"> 86</span>      <span class="n">igGrad</span><span class="p">[</span><span class="n">owner</span><span class="p">[</span><span class="n">facei</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">Sfssf</span><span class="p">;</span>
</span><span class="hll"><span class="linenos"> 87</span>      <span class="n">igGrad</span><span class="p">[</span><span class="n">neighbour</span><span class="p">[</span><span class="n">facei</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">Sfssf</span><span class="p">;</span>
</span><span class="hll"><span class="linenos"> 88</span>   <span class="p">}</span>
</span><span class="linenos"> 89</span>
<span class="linenos"> 90</span>   <span class="n">forAll</span><span class="p">(</span><span class="n">mesh</span><span class="p">.</span><span class="k">boundary</span><span class="p">(),</span> <span class="n">patchi</span><span class="p">)</span>
<span class="linenos"> 91</span>   <span class="p">{</span>
<span class="linenos"> 92</span>      <span class="k">const</span> <span class="n">labelUList</span><span class="o">&amp;</span> <span class="n">pFaceCells</span> <span class="o">=</span>
<span class="linenos"> 93</span>            <span class="n">mesh</span><span class="p">.</span><span class="k">boundary</span><span class="p">()[</span><span class="n">patchi</span><span class="p">].</span><span class="n">faceCells</span><span class="p">();</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>      <span class="k">const</span> <span class="n">vectorField</span><span class="o">&amp;</span> <span class="n">pSf</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">Sf</span><span class="p">().</span><span class="k">boundaryField</span><span class="p">()[</span><span class="n">patchi</span><span class="p">];</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span>      <span class="k">const</span> <span class="n">fvsPatchField</span><span class="o">&lt;</span><span class="n">Type</span><span class="o">&gt;&amp;</span> <span class="n">pssf</span> <span class="o">=</span> <span class="n">ssf</span><span class="p">.</span><span class="k">boundaryField</span><span class="p">()[</span><span class="n">patchi</span><span class="p">];</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>      <span class="n">forAll</span><span class="p">(</span><span class="n">mesh</span><span class="p">.</span><span class="k">boundary</span><span class="p">()[</span><span class="n">patchi</span><span class="p">],</span> <span class="n">facei</span><span class="p">)</span>
<span class="linenos">100</span>      <span class="p">{</span>
<span class="linenos">101</span>            <span class="n">igGrad</span><span class="p">[</span><span class="n">pFaceCells</span><span class="p">[</span><span class="n">facei</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">pSf</span><span class="p">[</span><span class="n">facei</span><span class="p">]</span><span class="o">*</span><span class="n">pssf</span><span class="p">[</span><span class="n">facei</span><span class="p">];</span>
<span class="linenos">102</span>      <span class="p">}</span>
<span class="linenos">103</span>   <span class="p">}</span>
<span class="linenos">104</span>
<span class="linenos">105</span>   <span class="n">igGrad</span> <span class="o">/=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">V</span><span class="p">();</span>
<span class="linenos">106</span>
<span class="linenos">107</span>   <span class="n">gGrad</span><span class="p">.</span><span class="n">correctBoundaryConditions</span><span class="p">();</span>
<span class="linenos">108</span>
<span class="linenos">109</span>   <span class="k">return</span> <span class="n">tgGrad</span><span class="p">;</span>
<span class="linenos">110</span><span class="p">}</span>
<span class="linenos">111</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="n">template</span><span class="o">&lt;</span><span class="kt">class</span> <span class="n">Type</span><span class="o">&gt;</span>
<span class="linenos">114</span><span class="n">Foam</span><span class="o">::</span><span class="n">tmp</span>
<span class="linenos">115</span><span class="o">&lt;</span>
<span class="linenos">116</span>   <span class="n">Foam</span><span class="o">::</span><span class="n">GeometricField</span>
<span class="linenos">117</span>   <span class="o">&lt;</span>
<span class="linenos">118</span>      <span class="kr">typename</span> <span class="n">Foam</span><span class="o">::</span><span class="n">outerProduct</span><span class="o">&lt;</span><span class="n">Foam</span><span class="o">::</span><span class="n">vector</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;::</span><span class="kt">type</span><span class="p">,</span>
<span class="linenos">119</span>      <span class="n">Foam</span><span class="o">::</span><span class="n">fvPatchField</span><span class="p">,</span>
<span class="linenos">120</span>      <span class="n">Foam</span><span class="o">::</span><span class="n">volMesh</span>
<span class="linenos">121</span>   <span class="o">&gt;</span>
<span class="linenos">122</span><span class="o">&gt;</span>
<span class="linenos">123</span><span class="n">Foam</span><span class="o">::</span><span class="n">fv</span><span class="o">::</span><span class="n">gaussGrad</span><span class="o">&lt;</span><span class="n">Type</span><span class="o">&gt;::</span><span class="n">calcGrad</span>
<span class="linenos">124</span><span class="p">(</span>
<span class="linenos">125</span>   <span class="k">const</span> <span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;&amp;</span> <span class="n">vsf</span><span class="p">,</span>
<span class="linenos">126</span>   <span class="k">const</span> <span class="n">word</span><span class="o">&amp;</span> <span class="n">name</span>
<span class="linenos">127</span><span class="p">)</span> <span class="k">const</span>
<span class="linenos">128</span><span class="p">{</span>
<span class="linenos">129</span>   <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">outerProduct</span><span class="o">&lt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;::</span><span class="kt">type</span> <span class="n">GradType</span><span class="p">;</span>
<span class="linenos">130</span>
<span class="linenos">131</span>   <span class="n">tmp</span><span class="o">&lt;</span><span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">GradType</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;&gt;</span> <span class="n">tgGrad</span>
<span class="linenos">132</span>   <span class="p">(</span>
<span class="linenos">133</span>      <span class="n">gradf</span><span class="p">(</span><span class="n">tinterpScheme_</span><span class="p">().</span><span class="n">interpolate</span><span class="p">(</span><span class="n">vsf</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">134</span>   <span class="p">);</span>
<span class="linenos">135</span>   <span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">GradType</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;&amp;</span> <span class="n">gGrad</span> <span class="o">=</span> <span class="n">tgGrad</span><span class="p">.</span><span class="n">ref</span><span class="p">();</span>
<span class="linenos">136</span>
<span class="linenos">137</span>   <span class="n">correctBoundaryConditions</span><span class="p">(</span><span class="n">vsf</span><span class="p">,</span> <span class="n">gGrad</span><span class="p">);</span>
<span class="linenos">138</span>
<span class="linenos">139</span>   <span class="k">return</span> <span class="n">tgGrad</span><span class="p">;</span>
<span class="linenos">140</span><span class="p">}</span>
<span class="linenos">141</span>
<span class="linenos">142</span>
<span class="linenos">143</span><span class="n">template</span><span class="o">&lt;</span><span class="kt">class</span> <span class="n">Type</span><span class="o">&gt;</span>
<span class="linenos">144</span><span class="kt">void</span> <span class="n">Foam</span><span class="o">::</span><span class="n">fv</span><span class="o">::</span><span class="n">gaussGrad</span><span class="o">&lt;</span><span class="n">Type</span><span class="o">&gt;::</span><span class="n">correctBoundaryConditions</span>
<span class="linenos">145</span><span class="p">(</span>
<span class="linenos">146</span>   <span class="k">const</span> <span class="n">GeometricField</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span><span class="o">&gt;&amp;</span> <span class="n">vsf</span><span class="p">,</span>
<span class="linenos">147</span>   <span class="n">GeometricField</span>
<span class="linenos">148</span>   <span class="o">&lt;</span>
<span class="linenos">149</span>      <span class="kr">typename</span> <span class="n">outerProduct</span><span class="o">&lt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;::</span><span class="kt">type</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span>
<span class="linenos">150</span>   <span class="o">&gt;&amp;</span> <span class="n">gGrad</span>
<span class="linenos">151</span><span class="p">)</span>
<span class="linenos">152</span><span class="p">{</span>
<span class="linenos">153</span>   <span class="kr">typename</span> <span class="n">GeometricField</span>
<span class="linenos">154</span>   <span class="o">&lt;</span>
<span class="linenos">155</span>      <span class="kr">typename</span> <span class="n">outerProduct</span><span class="o">&lt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;::</span><span class="kt">type</span><span class="p">,</span> <span class="n">fvPatchField</span><span class="p">,</span> <span class="n">volMesh</span>
<span class="linenos">156</span>   <span class="o">&gt;::</span><span class="n">Boundary</span><span class="o">&amp;</span> <span class="n">gGradbf</span> <span class="o">=</span> <span class="n">gGrad</span><span class="p">.</span><span class="n">boundaryFieldRef</span><span class="p">();</span>
<span class="linenos">157</span>
<span class="linenos">158</span>   <span class="n">forAll</span><span class="p">(</span><span class="n">vsf</span><span class="p">.</span><span class="k">boundaryField</span><span class="p">(),</span> <span class="n">patchi</span><span class="p">)</span>
<span class="linenos">159</span>   <span class="p">{</span>
<span class="linenos">160</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vsf</span><span class="p">.</span><span class="k">boundaryField</span><span class="p">()[</span><span class="n">patchi</span><span class="p">].</span><span class="n">coupled</span><span class="p">())</span>
<span class="linenos">161</span>      <span class="p">{</span>
<span class="linenos">162</span>            <span class="k">const</span> <span class="n">vectorField</span> <span class="k">n</span>
<span class="linenos">163</span>            <span class="p">(</span>
<span class="linenos">164</span>               <span class="n">vsf</span><span class="p">.</span><span class="n">mesh</span><span class="p">().</span><span class="n">Sf</span><span class="p">().</span><span class="k">boundaryField</span><span class="p">()[</span><span class="n">patchi</span><span class="p">]</span>
<span class="linenos">165</span>            <span class="o">/</span> <span class="n">vsf</span><span class="p">.</span><span class="n">mesh</span><span class="p">().</span><span class="n">magSf</span><span class="p">().</span><span class="k">boundaryField</span><span class="p">()[</span><span class="n">patchi</span><span class="p">]</span>
<span class="linenos">166</span>            <span class="p">);</span>
<span class="linenos">167</span>
<span class="linenos">168</span>            <span class="n">gGradbf</span><span class="p">[</span><span class="n">patchi</span><span class="p">]</span> <span class="o">+=</span> <span class="k">n</span> <span class="o">*</span>
<span class="linenos">169</span>            <span class="p">(</span>
<span class="linenos">170</span>               <span class="n">vsf</span><span class="p">.</span><span class="k">boundaryField</span><span class="p">()[</span><span class="n">patchi</span><span class="p">].</span><span class="n">snGrad</span><span class="p">()</span>
<span class="linenos">171</span>            <span class="o">-</span> <span class="p">(</span><span class="k">n</span> <span class="o">&amp;</span> <span class="n">gGradbf</span><span class="p">[</span><span class="n">patchi</span><span class="p">])</span>
<span class="linenos">172</span>            <span class="p">);</span>
<span class="linenos">173</span>      <span class="p">}</span>
<span class="linenos">174</span>   <span class="p">}</span>
<span class="linenos">175</span><span class="p">}</span>
<span class="linenos">176</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="c1">// ************************************************************************* //</span>
</pre></div>
</div>
</div>
</div>
<p>OpenFoam uses a matrix format that is tightly integrated with the “face-centered” and the owner/neighbor structure. It is called the LDU matrix format. This format is a way of storing sparse matrices. A sparse matrix is one in which most elements are zero, which is a common case in CFD (check the example above). The LDU format is specifically tailored to store and manipulate these types of matrices efficiently.</p>
<dl class="simple">
<dt><strong>Components of LDU:</strong></dt><dd><ul class="simple">
<li><p>L (Lower triangle): This part of the matrix stores the coefficients that are below the main diagonal.</p></li>
<li><p>D (Diagonal): This represents the main diagonal of the matrix. In many algorithms, the diagonal elements play a crucial role and are treated separately for reasons of numerical stability and efficiency.</p></li>
<li><p>U (Upper triangle): This stores the coefficients above the main diagonal.</p></li>
</ul>
</dd>
</dl>
<p>The LDU format is memory-efficient because it only stores non-zero elements. This is particularly beneficial in CFD where matrices can be very large, but only a small fraction of the elements are non-zero. OpenFOAM uses this structure to perform matrix operations like multiplication, addition, and especially the solving of linear systems, which is crucial in the iterative methods used in CFD simulations.</p>
<p>The LDU format uses scalar fields representing the diagonal, upper, and lower coefficients. The diagonal coefficients are indexed using the cell index. The upper and lower coefficients use face indices. In order to get the indices to match, mapping arrays between the face and cell indices are provided.  The <code class="code docutils literal notranslate"><span class="pre">lowerAddr()</span></code>, and <code class="code docutils literal notranslate"><span class="pre">upperAddr()</span></code> functions of the lduAdressing class provide the owner and neighbor cell indices for each face.</p>
<p>A nice summary of the LDU format can be found in the <a class="reference external" href="https://openfoamwiki.net/index.php/OpenFOAM_guide/Matrices_in_OpenFOAM">OpenFoam Wiki</a>.</p>
<div class="admonition-summary admonition">
<p class="admonition-title">Summary</p>
<p>In summary, the LDU format is a way of storing sparse matrices. It is specifically tailored to store and manipulate these types of matrices efficiently. OpenFOAM uses this structure to perform matrix operations like multiplication, addition, and especially the solving of linear systems, which is crucial in the iterative methods used in CFD simulations. Most of this happens under the hood but if you ever want to perform an operation on all rows of an lduMatrix, you need to know abou lduAdressing.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Overview.html" class="btn btn-neutral float-left" title="Lecture overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Implementation1.html" class="btn btn-neutral float-right" title="OpenFoam implementation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Lars Ruepke and Zhikui Guo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>